<!-- Good morning, Mr. Phelps. -->
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>or-tools/src/flatzinc/parser.cc Source File - Doxy</title>
    <link rel="shortcut icon" href="../../../favicon.ico">
    <!-- Both stylesheets are supplied by Doxygen, with maybe minor tweaks from Google. -->
    <link href="../../../doxygen.css" rel="stylesheet" type="text/css">
    <link href="../../../tabs.css" rel="stylesheet" type="text/css">
  </head>

  <body topmargin=0 leftmargin=20 bottommargin=0 rightmargin=20 marginwidth=20 marginheight=0>
  <!-- Second part of the secret behind Doxy logo always having the word "Doxy" with the color of the day. -->
  <style>
    a.doxy_logo:hover {
      background-color: #359621
    }
  </style>

  <table width=100% cellpadding=0 cellspacing=0 border=0>
    <!-- Top horizontal line with the color of the day. -->
    <tr valign=top>
      <td colspan=3 bgcolor=#359621 height=3></td>
    </tr>

    <!-- Header row with the links at the right. -->
    <tr valign=top>
      <td colspan=3 align=right>
        <font size=-1>
          Generated on: <font color=#359621><b>Fri Aug 10 00:46:07 CEST 2012</b></font>
            for Revision:2055
        </font>
      </td>
    </tr>

    <!-- Header row with the logo and the search form. -->
    <tr valign=top>
      <!-- Logo. -->
      <td align=left width=150>
        <table width=150 height=54 cellpadding=0 cellspacing=0 border=0>
          <tr valign=top>
            <!-- First part of the secret behind Doxy logo always having the word "Doxy" with the color of the day. -->
            <td bgcolor=#359621>
              <a class="doxy_logo" href="../../../index.html"><img src="../../../doxy_logo.png" alt="Doxy" border=0></a>
            </td>
          </tr>
        </table>
      </td>
    </tr>

    <!-- Tiny vertical space below the form. -->
    <tr valign=top>
      <td colspan=3 height=3></td>
    </tr>
  </table>

  <!-- Header navigation row. -->
  <div class="memproto">
    <table width=100% cellpadding=0 cellspacing=0 border=0>
      <tr>
        <td align=left style="padding-left: 20px"><font size=+1><b><tt><font color=#333333>//
            <a href="../../../index.html"><font color=#359621>doxy</font></a>/</font>
            <a href="../../../or-tools/index.html">or-tools</a>/
            <a href="../../../or-tools/src/index.html">src</a>/
            <a href="../../../or-tools/src/flatzinc/index.html">flatzinc</a>/
            </tt></b></font>
        </td>
      </tr>
    </table>
  </div>
  <br />
    <!-- No subdirs found. -->
  <!-- End of header. -->
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>or-tools/src/flatzinc/parser.cc</h1><a href="parser_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// Copyright 2010-2012 Google</span>
<a name="l00002"></a>00002 <span class="comment">// Licensed under the Apache License, Version 2.0 (the "License");</span>
<a name="l00003"></a>00003 <span class="comment">// you may not use this file except in compliance with the License.</span>
<a name="l00004"></a>00004 <span class="comment">// You may obtain a copy of the License at</span>
<a name="l00005"></a>00005 <span class="comment">//</span>
<a name="l00006"></a>00006 <span class="comment">//     http://www.apache.org/licenses/LICENSE-2.0</span>
<a name="l00007"></a>00007 <span class="comment">//</span>
<a name="l00008"></a>00008 <span class="comment">// Unless required by applicable law or agreed to in writing, software</span>
<a name="l00009"></a>00009 <span class="comment">// distributed under the License is distributed on an "AS IS" BASIS,</span>
<a name="l00010"></a>00010 <span class="comment">// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<a name="l00011"></a>00011 <span class="comment">// See the License for the specific language governing permissions and</span>
<a name="l00012"></a>00012 <span class="comment">// limitations under the License.</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include "base/stl_util.h"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "base/stringprintf.h"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="flatzinc_8h.html">flatzinc/flatzinc.h</a>"</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="parser_8h.html">flatzinc/parser.h</a>"</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "flatzinc/parser.tab.h"</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="keyword">using namespace </span>std;
<a name="l00026"></a>00026 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="parser_8cc.html#2df08e98c81c9d8bc1fd71defa327d4d">yyparse</a>(<span class="keywordtype">void</span>*);
<a name="l00027"></a>00027 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="lexer_8win_8cc.html#daeeff4d42ab7f57df3ad648082015d4">yylex</a>(<a class="code" href="unionYYSTYPE.html">YYSTYPE</a>*, <span class="keywordtype">void</span>* scanner);
<a name="l00028"></a>00028 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="lexer_8win_8cc.html#97c2c3079904c5fb2f235bb806ff20c7" title="User-visible API.">yylex_init</a> (<span class="keywordtype">void</span>** scanner);
<a name="l00029"></a>00029 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="lexer_8win_8cc.html#aea60d8102c2afdd7d8e07bc43c530c3" title="Accessor methods to globals.">yylex_destroy</a> (<span class="keywordtype">void</span>* scanner);
<a name="l00030"></a>00030 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="lexer_8win_8cc.html#86cef2b171b5abc4f80a9d55b839e7c2" title="Get the current line number.">yyget_lineno</a> (<span class="keywordtype">void</span>* scanner);
<a name="l00031"></a>00031 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="lexer_8win_8cc.html#90d20294722d171c4bf004fda3cd9403" title="Set the user-defined data.">yyset_extra</a> (<span class="keywordtype">void</span>* user_defined ,<span class="keywordtype">void</span>* yyscanner );
<a name="l00032"></a>00032 <span class="keyword">extern</span> <span class="keywordtype">void</span> <a class="code" href="lexer_8win_8cc.html#5b7e55e05d5336ae2651b75a7846430e">yyerror</a>(<span class="keywordtype">void</span>* <a class="code" href="parser_8win_8cc.html#76448533848f5e8b0541c4bbb9101525">parm</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *str);
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 DECLARE_bool(use_minisat);
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="keyword">namespace </span>operations_research {
<a name="l00037"></a>00037 <span class="comment">// ----- Misc -----</span>
<a name="l00038"></a><a class="code" href="namespaceoperations__research.html#ef28c306da5414e37a8dc3676adf2b89">00038</a> <span class="keywordtype">bool</span> <a class="code" href="namespaceoperations__research.html#ef28c306da5414e37a8dc3676adf2b89" title="Misc.">HasDomainAnnotation</a>(<a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> annotations) {
<a name="l00039"></a>00039   <span class="keywordflow">if</span> (annotations != NULL) {
<a name="l00040"></a>00040     <span class="keywordflow">return</span> annotations-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#d822048b8a63f4b9b73c7ea542fffe43" title="Test if node has atom with id.">hasAtom</a>(<span class="stringliteral">"domain"</span>);
<a name="l00041"></a>00041   }
<a name="l00042"></a>00042   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00043"></a>00043 }
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="namespaceoperations__research.html#310a33e66757f57c39f28f08009ab8a9">00045</a> <span class="keywordtype">bool</span> <a class="code" href="namespaceoperations__research.html#310a33e66757f57c39f28f08009ab8a9">HasDefineAnnotation</a>(<a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> annotations) {
<a name="l00046"></a>00046   <span class="keywordflow">if</span> (annotations != NULL) {
<a name="l00047"></a>00047     <span class="keywordflow">if</span> (annotations-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#72542d2c0699a56955a3fad8fdd979b6" title="Test if node is an array node.">isArray</a>()) {
<a name="l00048"></a>00048       <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>* <span class="keyword">const</span> ann_array = annotations-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#de326d9355b68c1d6b8e33a8521313fd" title="Cast this node to an array node.">getArray</a>();
<a name="l00049"></a>00049       <span class="keywordflow">if</span> (ann_array-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[0]-&gt;isCall(<span class="stringliteral">"defines_var"</span>)) {
<a name="l00050"></a>00050         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00051"></a>00051       }
<a name="l00052"></a>00052     }
<a name="l00053"></a>00053   }
<a name="l00054"></a>00054   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00055"></a>00055 }
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment">// ----- Parser State -----</span>
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="classoperations__research_1_1ParserState.html#16bca8ec51bc09f90dc8dfb210b0e156">00059</a> <a class="code" href="classoperations__research_1_1ParserState.html#16bca8ec51bc09f90dc8dfb210b0e156" title="Parser State.">ParserState::~ParserState</a>() {
<a name="l00060"></a>00060   STLDeleteElements(&amp;<a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>);
<a name="l00061"></a>00061   STLDeleteElements(&amp;<a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>);
<a name="l00062"></a>00062   STLDeleteElements(&amp;<a class="code" href="classoperations__research_1_1ParserState.html#b25b9ef5be1cf155545ea830fd7f2387">set_variables_</a>);
<a name="l00063"></a>00063   STLDeleteElements(&amp;<a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>);
<a name="l00064"></a>00064   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#627c907b2095e594d29c34ee12ec4492">int_domain_constraints_</a>.size(); ++i) {
<a name="l00065"></a>00065     <span class="keyword">delete</span> <a class="code" href="classoperations__research_1_1ParserState.html#627c907b2095e594d29c34ee12ec4492">int_domain_constraints_</a>[i].first;
<a name="l00066"></a>00066     <span class="keyword">delete</span> <a class="code" href="classoperations__research_1_1ParserState.html#627c907b2095e594d29c34ee12ec4492">int_domain_constraints_</a>[i].second;
<a name="l00067"></a>00067   }
<a name="l00068"></a>00068   STLDeleteElements(&amp;int_args_);
<a name="l00069"></a>00069   STLDeleteElements(&amp;bool_args_);
<a name="l00070"></a>00070 }
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="classoperations__research_1_1ParserState.html#8ff208516a2e517219bce5f024d696f1">00072</a> <span class="keywordtype">int</span> ParserState::FillBuffer(<span class="keywordtype">char</span>* lexBuf, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lexBufSize) {
<a name="l00073"></a>00073   <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#41e5a05891685c95b74b9418e3de41af">pos</a> &gt;= <a class="code" href="classoperations__research_1_1ParserState.html#b2542cc0b900cded649c1a38414c3a72">length</a>)
<a name="l00074"></a>00074     <span class="keywordflow">return</span> 0;
<a name="l00075"></a>00075   <span class="keywordtype">int</span> num = std::min(<a class="code" href="classoperations__research_1_1ParserState.html#b2542cc0b900cded649c1a38414c3a72">length</a> - <a class="code" href="classoperations__research_1_1ParserState.html#41e5a05891685c95b74b9418e3de41af">pos</a>, lexBufSize);
<a name="l00076"></a>00076   memcpy(lexBuf, <a class="code" href="classoperations__research_1_1ParserState.html#152a4a0410734c47b6b4c4d4c39f0c31">buf</a> + <a class="code" href="classoperations__research_1_1ParserState.html#41e5a05891685c95b74b9418e3de41af">pos</a>, num);
<a name="l00077"></a>00077   <a class="code" href="classoperations__research_1_1ParserState.html#41e5a05891685c95b74b9418e3de41af">pos</a> += num;
<a name="l00078"></a>00078   <span class="keywordflow">return</span> num;
<a name="l00079"></a>00079 }
<a name="l00080"></a>00080 
<a name="l00081"></a><a class="code" href="classoperations__research_1_1ParserState.html#3076b67257efb954758e416f663d8d06">00081</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1ParserState.html#3076b67257efb954758e416f663d8d06">ParserState::output</a>(std::string x, <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* n) {
<a name="l00082"></a>00082   output_.push_back(std::pair&lt;std::string,AstNode*&gt;(x,n));
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 <span class="comment"></span>
<a name="l00085"></a>00085 <span class="comment">/// Strict weak ordering for output items</span>
<a name="l00086"></a><a class="code" href="classoperations__research_1_1OutputOrder.html">00086</a> <span class="comment"></span><span class="keyword">class </span><a class="code" href="classoperations__research_1_1OutputOrder.html" title="Strict weak ordering for output items.">OutputOrder</a> {
<a name="l00087"></a>00087  <span class="keyword">public</span>:<span class="comment"></span>
<a name="l00088"></a>00088 <span class="comment">  /// Return if \a x is less than \a y, based on first component</span>
<a name="l00089"></a><a class="code" href="classoperations__research_1_1OutputOrder.html#d3aa1e52fe067ed5f64f94b3333e9e5c">00089</a> <span class="comment"></span>  <span class="keywordtype">bool</span> operator ()(<span class="keyword">const</span> std::pair&lt;std::string, AstNode*&gt;&amp; x,
<a name="l00090"></a>00090                    <span class="keyword">const</span> std::pair&lt;std::string, AstNode*&gt;&amp; y) {
<a name="l00091"></a>00091     <span class="keywordflow">return</span> x.first &lt; y.first;
<a name="l00092"></a>00092   }
<a name="l00093"></a>00093 };
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="classoperations__research_1_1ParserState.html#6dda89067c3a8489d6af4d561fe4a054">00095</a> <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>* <a class="code" href="classoperations__research_1_1ParserState.html#6dda89067c3a8489d6af4d561fe4a054">ParserState::Output</a>(<span class="keywordtype">void</span>) {
<a name="l00096"></a>00096   <a class="code" href="classoperations__research_1_1OutputOrder.html" title="Strict weak ordering for output items.">OutputOrder</a> oo;
<a name="l00097"></a>00097   std::sort(output_.begin(), output_.end(), oo);
<a name="l00098"></a>00098   <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>* <span class="keyword">const</span> a = <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>();
<a name="l00099"></a>00099   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; output_.size(); i++) {
<a name="l00100"></a>00100     a-&gt;a.push_back(<span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstString.html" title="String node">AstString</a>(output_[i].first+<span class="stringliteral">" = "</span>));
<a name="l00101"></a>00101     <span class="keywordflow">if</span> (output_[i].second-&gt;isArray()) {
<a name="l00102"></a>00102       <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>* <span class="keyword">const</span> oa = output_[i].second-&gt;getArray();
<a name="l00103"></a>00103       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; oa-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>.size(); j++) {
<a name="l00104"></a>00104         a-&gt;a.push_back(oa-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[j]);
<a name="l00105"></a>00105         oa-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[j] = NULL;
<a name="l00106"></a>00106       }
<a name="l00107"></a>00107       <span class="keyword">delete</span> output_[i].second;
<a name="l00108"></a>00108     } <span class="keywordflow">else</span> {
<a name="l00109"></a>00109       a-&gt;a.push_back(output_[i].second);
<a name="l00110"></a>00110     }
<a name="l00111"></a>00111     a-&gt;a.push_back(<span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstString.html" title="String node">AstString</a>(<span class="stringliteral">";\n"</span>));
<a name="l00112"></a>00112   }
<a name="l00113"></a>00113   <span class="keywordflow">return</span> a;
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* ParserState::FindTarget(<a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> annotations)<span class="keyword"> const </span>{
<a name="l00117"></a>00117   <span class="keywordflow">if</span> (annotations != NULL) {
<a name="l00118"></a>00118     <span class="keywordflow">if</span> (annotations-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#72542d2c0699a56955a3fad8fdd979b6" title="Test if node is an array node.">isArray</a>()) {
<a name="l00119"></a>00119       <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>* <span class="keyword">const</span> ann_array = annotations-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#de326d9355b68c1d6b8e33a8521313fd" title="Cast this node to an array node.">getArray</a>();
<a name="l00120"></a>00120       <span class="keywordflow">if</span> (ann_array-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[0]-&gt;isCall(<span class="stringliteral">"defines_var"</span>)) {
<a name="l00121"></a>00121         <a class="code" href="classoperations__research_1_1AstCall.html" title="Node representing a function call">AstCall</a>* <span class="keyword">const</span> call = ann_array-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[0]-&gt;getCall();
<a name="l00122"></a>00122         <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> args = call-&gt;<a class="code" href="classoperations__research_1_1AstCall.html#6c7424ca9ecbdc2908866948d163d979">args</a>;
<a name="l00123"></a>00123         <span class="keywordflow">return</span> <a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(args);
<a name="l00124"></a>00124       }
<a name="l00125"></a>00125     }
<a name="l00126"></a>00126   }
<a name="l00127"></a>00127   <span class="keywordflow">return</span> NULL;
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="keywordtype">void</span> ParserState::CollectRequired(AstArray* <span class="keyword">const</span> args,
<a name="l00131"></a>00131                                   <span class="keyword">const</span> <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>&amp; candidates,
<a name="l00132"></a>00132                                   <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>* <span class="keyword">const</span> require)<span class="keyword"> const </span>{
<a name="l00133"></a>00133   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; args-&gt;a.size(); ++i) {
<a name="l00134"></a>00134     AstNode* <span class="keyword">const</span> node = args-&gt;a[i];
<a name="l00135"></a>00135     <span class="keywordflow">if</span> (node-&gt;isArray()) {
<a name="l00136"></a>00136       CollectRequired(node-&gt;getArray(), candidates, require);
<a name="l00137"></a>00137     } <span class="keywordflow">else</span> {
<a name="l00138"></a>00138       AstNode* <span class="keyword">const</span> copy = <a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(node);
<a name="l00139"></a>00139       <span class="keywordflow">if</span> (copy != NULL &amp;&amp; ContainsKey(candidates, copy)) {
<a name="l00140"></a>00140         require-&gt;insert(copy);
<a name="l00141"></a>00141       }
<a name="l00142"></a>00142     }
<a name="l00143"></a>00143   }
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="keywordtype">void</span> ParserState::ComputeViableTarget(CtSpec* <span class="keyword">const</span> spec,
<a name="l00147"></a>00147                                       <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>* <span class="keyword">const</span> candidates)<span class="keyword"> const </span>{
<a name="l00148"></a>00148   <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; <span class="keywordtype">id</span> = spec-&gt;Id();
<a name="l00149"></a>00149   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"bool2int"</span> ||
<a name="l00150"></a>00150       <span class="keywordtype">id</span> == <span class="stringliteral">"int_plus"</span> ||
<a name="l00151"></a>00151       <span class="keywordtype">id</span> == <span class="stringliteral">"int_minus"</span> ||
<a name="l00152"></a>00152       <span class="keywordtype">id</span> == <span class="stringliteral">"int_times"</span> ||
<a name="l00153"></a>00153       (<span class="keywordtype">id</span> == <span class="stringliteral">"array_var_int_element"</span> &amp;&amp; !<a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;Arg(2))) ||
<a name="l00154"></a>00154       <span class="keywordtype">id</span> == <span class="stringliteral">"array_int_element"</span> ||
<a name="l00155"></a>00155       <span class="keywordtype">id</span> == <span class="stringliteral">"int_abs"</span> ||
<a name="l00156"></a>00156       (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_eq"</span> &amp;&amp; !<a class="code" href="namespaceoperations__research.html#ef28c306da5414e37a8dc3676adf2b89" title="Misc.">HasDomainAnnotation</a>(spec-&gt;annotations())) ||
<a name="l00157"></a>00157       <span class="keywordtype">id</span> == <span class="stringliteral">"int_max"</span> ||
<a name="l00158"></a>00158       <span class="keywordtype">id</span> == <span class="stringliteral">"int_min"</span> ||
<a name="l00159"></a>00159       <span class="keywordtype">id</span> == <span class="stringliteral">"int_eq"</span>) {
<a name="l00160"></a>00160     <span class="comment">// Defines an int var.</span>
<a name="l00161"></a>00161     AstNode* <span class="keyword">const</span> define = FindTarget(spec-&gt;annotations());
<a name="l00162"></a>00162     <span class="keywordflow">if</span> (define != NULL) {
<a name="l00163"></a>00163       <span class="comment">//      CHECK(IsIntroduced(define));</span>
<a name="l00164"></a>00164       candidates-&gt;insert(define);
<a name="l00165"></a>00165       VLOG(2) &lt;&lt; <span class="keywordtype">id</span> &lt;&lt; <span class="stringliteral">" -&gt; insert "</span> &lt;&lt; define-&gt;DebugString();
<a name="l00166"></a>00166     }
<a name="l00167"></a>00167   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<span class="keywordtype">id</span> == <span class="stringliteral">"array_bool_and"</span> &amp;&amp; !FLAGS_use_minisat) ||
<a name="l00168"></a>00168              (<span class="keywordtype">id</span> == <span class="stringliteral">"array_bool_or"</span> &amp;&amp; !FLAGS_use_minisat) ||
<a name="l00169"></a>00169              <span class="keywordtype">id</span> == <span class="stringliteral">"array_bool_element"</span> ||
<a name="l00170"></a>00170              <span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_eq_reif"</span> ||
<a name="l00171"></a>00171              <span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_ne_reif"</span> ||
<a name="l00172"></a>00172              <span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_ge_reif"</span> ||
<a name="l00173"></a>00173              <span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_le_reif"</span> ||
<a name="l00174"></a>00174              <span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_gt_reif"</span> ||
<a name="l00175"></a>00175              <span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_lt_reif"</span> ||
<a name="l00176"></a>00176              <span class="keywordtype">id</span> == <span class="stringliteral">"int_eq_reif"</span> ||
<a name="l00177"></a>00177              <span class="keywordtype">id</span> == <span class="stringliteral">"int_ne_reif"</span> ||
<a name="l00178"></a>00178              <span class="keywordtype">id</span> == <span class="stringliteral">"int_le_reif"</span> ||
<a name="l00179"></a>00179              <span class="keywordtype">id</span> == <span class="stringliteral">"int_ge_reif"</span> ||
<a name="l00180"></a>00180              (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_eq_reif"</span> &amp;&amp; !FLAGS_use_minisat) ||
<a name="l00181"></a>00181              (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_ne_reif"</span> &amp;&amp; !FLAGS_use_minisat) ||
<a name="l00182"></a>00182              (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_le_reif"</span> &amp;&amp; !FLAGS_use_minisat) ||
<a name="l00183"></a>00183              (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_ge_reif"</span> &amp;&amp; !FLAGS_use_minisat) ||
<a name="l00184"></a>00184              <span class="keywordtype">id</span> == <span class="stringliteral">"bool_not"</span>) {
<a name="l00185"></a>00185     <span class="comment">// Defines a bool var.</span>
<a name="l00186"></a>00186     AstNode* <span class="keyword">const</span> bool_define = FindTarget(spec-&gt;annotations());
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (bool_define != NULL) {
<a name="l00188"></a>00188       CHECK(IsIntroduced(bool_define));
<a name="l00189"></a>00189       candidates-&gt;insert(bool_define);
<a name="l00190"></a>00190       VLOG(2) &lt;&lt; <span class="keywordtype">id</span> &lt;&lt; <span class="stringliteral">" -&gt; insert "</span> &lt;&lt; bool_define-&gt;DebugString();
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int2int"</span> || <span class="keywordtype">id</span> == <span class="stringliteral">"bool2bool"</span>) {
<a name="l00193"></a>00193     candidates-&gt;insert(<a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(spec-&gt;Arg(1)));
<a name="l00194"></a>00194     VLOG(2) &lt;&lt; <span class="keywordtype">id</span> &lt;&lt; <span class="stringliteral">" -&gt; insert "</span> &lt;&lt; spec-&gt;Arg(1)-&gt;DebugString();
<a name="l00195"></a>00195   }
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="keywordtype">void</span> ParserState::ComputeDependencies(<span class="keyword">const</span> <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>&amp; candidates,
<a name="l00199"></a>00199                                       CtSpec* <span class="keyword">const</span> spec)<span class="keyword"> const </span>{
<a name="l00200"></a>00200   AstNode* <span class="keyword">const</span> define = spec-&gt;DefinedArg() == NULL ?
<a name="l00201"></a>00201       FindTarget(spec-&gt;annotations()) :
<a name="l00202"></a>00202       spec-&gt;DefinedArg();
<a name="l00203"></a>00203   <span class="keywordflow">if</span> (ContainsKey(candidates, define)) {
<a name="l00204"></a>00204     spec-&gt;SetDefinedArg(define);
<a name="l00205"></a>00205   }
<a name="l00206"></a>00206   <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>* <span class="keyword">const</span> requires = spec-&gt;mutable_require_map();
<a name="l00207"></a>00207   CollectRequired(spec-&gt;Args(), candidates, requires);
<a name="l00208"></a>00208   <span class="keywordflow">if</span> (define != NULL) {
<a name="l00209"></a>00209     requires-&gt;erase(define);
<a name="l00210"></a>00210   }
<a name="l00211"></a>00211 }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="keywordtype">void</span> ParserState::MarkAllVariables(AstNode* <span class="keyword">const</span> node,
<a name="l00214"></a>00214                                    <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>* <span class="keyword">const</span> computed) {
<a name="l00215"></a>00215   <span class="keywordflow">if</span> (node-&gt;isIntVar()) {
<a name="l00216"></a>00216     computed-&gt;insert(<a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(node));
<a name="l00217"></a>00217     VLOG(1) &lt;&lt; <span class="stringliteral">"  - "</span> &lt;&lt; node-&gt;DebugString();
<a name="l00218"></a>00218   }
<a name="l00219"></a>00219   <span class="keywordflow">if</span> (node-&gt;isArray()) {
<a name="l00220"></a>00220     AstArray* <span class="keyword">const</span> array = node-&gt;getArray();
<a name="l00221"></a>00221     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; array-&gt;a.size(); ++i) {
<a name="l00222"></a>00222       <span class="keywordflow">if</span> (array-&gt;a[i]-&gt;isIntVar()) {
<a name="l00223"></a>00223         computed-&gt;insert(<a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(array-&gt;a[i]));
<a name="l00224"></a>00224         VLOG(1) &lt;&lt; <span class="stringliteral">"  - "</span> &lt;&lt; array-&gt;a[i]-&gt;DebugString();
<a name="l00225"></a>00225       }
<a name="l00226"></a>00226     }
<a name="l00227"></a>00227   }
<a name="l00228"></a>00228 }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230 <span class="keywordtype">void</span> ParserState::MarkComputedVariables(CtSpec* <span class="keyword">const</span> spec,
<a name="l00231"></a>00231                                         <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>* <span class="keyword">const</span> computed) {
<a name="l00232"></a>00232   <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; <span class="keywordtype">id</span> = spec-&gt;Id();
<a name="l00233"></a>00233   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"global_cardinality"</span>) {
<a name="l00234"></a>00234     VLOG(1) &lt;&lt; <span class="stringliteral">"Marking "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l00235"></a>00235     MarkAllVariables(spec-&gt;Arg(2), computed);
<a name="l00236"></a>00236   }
<a name="l00237"></a>00237   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_eq"</span> &amp;&amp; spec-&gt;DefinedArg() == NULL) {
<a name="l00238"></a>00238     AstArray* <span class="keyword">const</span> array_coefficients = spec-&gt;Arg(0)-&gt;getArray();
<a name="l00239"></a>00239     <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_coefficients-&gt;a.size();
<a name="l00240"></a>00240     <span class="keywordflow">if</span> (array_coefficients-&gt;a[0]-&gt;getInt() == -1) {
<a name="l00241"></a>00241       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 1; i &lt; size; ++i) {
<a name="l00242"></a>00242         <span class="keywordflow">if</span> (array_coefficients-&gt;a[i]-&gt;getInt() &lt; 0) {
<a name="l00243"></a>00243           <span class="keywordflow">return</span>;
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245       }
<a name="l00246"></a>00246       <span class="comment">// Can mark the first one, this is a hidden sum.</span>
<a name="l00247"></a>00247       VLOG(1) &lt;&lt; <span class="stringliteral">"Marking "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l00248"></a>00248       AstArray* <span class="keyword">const</span> array_variables = spec-&gt;Arg(1)-&gt;getArray();
<a name="l00249"></a>00249       computed-&gt;insert(<a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(array_variables-&gt;a[0]));
<a name="l00250"></a>00250       VLOG(1) &lt;&lt; <span class="stringliteral">"  - "</span> &lt;&lt; array_variables-&gt;a[0]-&gt;DebugString();
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252   }
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 <span class="keywordtype">void</span> ParserState::Sanitize(CtSpec* <span class="keyword">const</span> spec) {
<a name="l00256"></a>00256   <span class="keywordflow">if</span> (spec-&gt;Id() == <span class="stringliteral">"int_lin_eq"</span> &amp;&amp; <a class="code" href="namespaceoperations__research.html#ef28c306da5414e37a8dc3676adf2b89" title="Misc.">HasDomainAnnotation</a>(spec-&gt;annotations())) {
<a name="l00257"></a>00257     AstArray* <span class="keyword">const</span> array_coefficients = spec-&gt;Arg(0)-&gt;getArray();
<a name="l00258"></a>00258     <span class="keywordflow">if</span> (array_coefficients-&gt;a.size() &gt; 2) {
<a name="l00259"></a>00259       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve: remove defines part on "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l00260"></a>00260       spec-&gt;RemoveDefines();
<a name="l00261"></a>00261     } <span class="keywordflow">else</span> {
<a name="l00262"></a>00262       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve: remove domain part on "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l00263"></a>00263       spec-&gt;RemoveDomain();
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265   }
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
<a name="l00268"></a><a class="code" href="classoperations__research_1_1ParserState.html#7f38a3cfd87a0e2766166cdac6f69595">00268</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1ParserState.html#7f38a3cfd87a0e2766166cdac6f69595">ParserState::Presolve</a>() {
<a name="l00269"></a>00269   <span class="comment">// Sanity.</span>
<a name="l00270"></a>00270   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); ++i) {
<a name="l00271"></a>00271     Sanitize(<a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i]);
<a name="l00272"></a>00272   }
<a name="l00273"></a>00273   <span class="comment">// Find orphans (is_defined &amp;&amp; not a viable target).</span>
<a name="l00274"></a>00274   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); ++i) {
<a name="l00275"></a>00275     <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> target = FindTarget(<a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i]-&gt;annotations());
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (target != NULL) {
<a name="l00277"></a>00277       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  mark "</span> &lt;&lt; target-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#6e981e3dac0a576beecf101e5d89a806" title="Output string representation.">DebugString</a>()
<a name="l00278"></a>00278               &lt;&lt; <span class="stringliteral">" as defined"</span>;
<a name="l00279"></a>00279       targets_.insert(target);
<a name="l00280"></a>00280     }
<a name="l00281"></a>00281   }
<a name="l00282"></a>00282   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>.size(); ++i) {
<a name="l00283"></a>00283     <a class="code" href="classoperations__research_1_1IntVarSpec.html" title="Specification for integer variables.">IntVarSpec</a>* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[i];
<a name="l00284"></a>00284     <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> var = <a class="code" href="classoperations__research_1_1ParserState.html#7e35c8b6cd4483e4f1aa2de03addf1fe">IntCopy</a>(i);
<a name="l00285"></a>00285     <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="classoperations__research_1_1VarSpec.html#82edb5cf8c426584eeb01ab6da9206d1" title="Whether the variable was introduced in the mzn2fzn translation.">introduced</a> &amp;&amp; !ContainsKey(targets_, var)) {
<a name="l00286"></a>00286       orphans_.insert(var);
<a name="l00287"></a>00287       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  mark "</span> &lt;&lt; var-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#6e981e3dac0a576beecf101e5d89a806" title="Output string representation.">DebugString</a>() &lt;&lt; <span class="stringliteral">" as orphan"</span>;
<a name="l00288"></a>00288     }
<a name="l00289"></a>00289   }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291   <span class="comment">// Collect aliases.</span>
<a name="l00292"></a>00292   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>.size(); ++i) {
<a name="l00293"></a>00293     <a class="code" href="classoperations__research_1_1IntVarSpec.html" title="Specification for integer variables.">IntVarSpec</a>* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[i];
<a name="l00294"></a>00294     <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="classoperations__research_1_1VarSpec.html#2981dccb73c085ac5569937849df3775" title="Whether the variable aliases another variable.">alias</a>) {
<a name="l00295"></a>00295       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve: xi("</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">") is aliased to xi("</span> &lt;&lt; spec-&gt;<a class="code" href="classoperations__research_1_1VarSpec.html#a0e015c6620a90b2f46a405dacdf7a20" title="Variable index.">i</a>
<a name="l00296"></a>00296               &lt;&lt; <span class="stringliteral">")"</span>;
<a name="l00297"></a>00297       int_aliases_[i] = spec-&gt;<a class="code" href="classoperations__research_1_1VarSpec.html#a0e015c6620a90b2f46a405dacdf7a20" title="Variable index.">i</a>;
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299   }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301   <span class="comment">// Discover new aliases</span>
<a name="l00302"></a>00302   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); ++i) {
<a name="l00303"></a>00303     <a class="code" href="classoperations__research_1_1CtSpec.html">CtSpec</a>* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i];
<a name="l00304"></a>00304     <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#4b81df3faa511399839966edfe87bcc1">Nullified</a>()) {
<a name="l00305"></a>00305       <span class="keywordflow">continue</span>;
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307     DiscoverAliases(spec);
<a name="l00308"></a>00308   }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310   <span class="comment">// Merge domains of aliases, update alias map to point to root.</span>
<a name="l00311"></a>00311   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>.size(); ++i) {
<a name="l00312"></a>00312     <a class="code" href="classoperations__research_1_1IntVarSpec.html" title="Specification for integer variables.">IntVarSpec</a>* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[i];
<a name="l00313"></a>00313     <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> var = <a class="code" href="classoperations__research_1_1ParserState.html#7e35c8b6cd4483e4f1aa2de03addf1fe">IntCopy</a>(i);
<a name="l00314"></a>00314     <span class="comment">// TODO(lperron) : loop on hash_table.</span>
<a name="l00315"></a>00315     <span class="keywordflow">if</span> (ContainsKey(int_aliases_, i)) {
<a name="l00316"></a>00316       <span class="keywordtype">int</span> index = i;
<a name="l00317"></a>00317       <span class="keywordflow">while</span> (<a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[index]-&gt;alias) {
<a name="l00318"></a>00318         index = <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[index]-&gt;i;
<a name="l00319"></a>00319       }
<a name="l00320"></a>00320       int_aliases_[i] = index;
<a name="l00321"></a>00321       <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="classoperations__research_1_1IntVarSpec.html#33efa9eb05364d1d968a42a119b64b65">HasDomain</a>()) {
<a name="l00322"></a>00322         <a class="code" href="classoperations__research_1_1ParserState.html#5a5475004786923ae85b7ec5b8084442">MergeIntDomain</a>(spec, <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[index]);
<a name="l00323"></a>00323       }
<a name="l00324"></a>00324     }
<a name="l00325"></a>00325   }
<a name="l00326"></a>00326 
<a name="l00327"></a>00327   <span class="comment">// Remove all aliases from constraints.</span>
<a name="l00328"></a>00328   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); ++i) {
<a name="l00329"></a>00329     <a class="code" href="classoperations__research_1_1CtSpec.html">CtSpec</a>* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i];
<a name="l00330"></a>00330     <span class="keywordflow">if</span> (!spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#4b81df3faa511399839966edfe87bcc1">Nullified</a>()) {
<a name="l00331"></a>00331       ReplaceAliases(spec);
<a name="l00332"></a>00332     }
<a name="l00333"></a>00333   }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335   <span class="comment">// Presolve (propagate bounds, simplify constraints...).</span>
<a name="l00336"></a>00336   <span class="keywordtype">bool</span> repeat = <span class="keyword">true</span>;
<a name="l00337"></a>00337   <span class="keywordflow">while</span> (repeat) {
<a name="l00338"></a>00338     repeat = <span class="keyword">false</span>;
<a name="l00339"></a>00339     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); ++i) {
<a name="l00340"></a>00340       <a class="code" href="classoperations__research_1_1CtSpec.html">CtSpec</a>* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i];
<a name="l00341"></a>00341       <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#4b81df3faa511399839966edfe87bcc1">Nullified</a>()) {
<a name="l00342"></a>00342         <span class="keywordflow">continue</span>;
<a name="l00343"></a>00343       }
<a name="l00344"></a>00344       <span class="keywordflow">if</span> (PresolveOneConstraint(spec)) {
<a name="l00345"></a>00345         repeat = <span class="keyword">true</span>;
<a name="l00346"></a>00346       }
<a name="l00347"></a>00347     }
<a name="l00348"></a>00348   }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350   <span class="comment">// Add aliasing constraints.</span>
<a name="l00351"></a>00351   <span class="comment">// for (int i = 0; i &lt; int_variables_.size(); ++i) {</span>
<a name="l00352"></a>00352   <span class="comment">//   IntVarSpec* const spec = int_variables_[i];</span>
<a name="l00353"></a>00353   <span class="comment">//   if (spec-&gt;alias) {</span>
<a name="l00354"></a>00354   <span class="comment">//     AstArray* args = new AstArray(2);</span>
<a name="l00355"></a>00355   <span class="comment">//     args-&gt;a[0] = new AstIntVar(spec-&gt;i);</span>
<a name="l00356"></a>00356   <span class="comment">//     args-&gt;a[1] = new AstIntVar(i);</span>
<a name="l00357"></a>00357   <span class="comment">//     CtSpec* const alias_ct = new CtSpec(constraints_.size(),</span>
<a name="l00358"></a>00358   <span class="comment">//                                         "int2int",</span>
<a name="l00359"></a>00359   <span class="comment">//                                         args,</span>
<a name="l00360"></a>00360   <span class="comment">//                                         NULL);</span>
<a name="l00361"></a>00361   <span class="comment">//     alias_ct-&gt;SetDefinedArg(IntCopy(i));</span>
<a name="l00362"></a>00362   <span class="comment">//     constraints_.push_back(alias_ct);</span>
<a name="l00363"></a>00363   <span class="comment">//   }</span>
<a name="l00364"></a>00364   <span class="comment">// }</span>
<a name="l00365"></a>00365 
<a name="l00366"></a>00366   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>.size(); ++i) {
<a name="l00367"></a>00367     <a class="code" href="classoperations__research_1_1BoolVarSpec.html" title="Specification for Boolean variables.">BoolVarSpec</a>* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>[i];
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="classoperations__research_1_1VarSpec.html#2981dccb73c085ac5569937849df3775" title="Whether the variable aliases another variable.">alias</a>) {
<a name="l00369"></a>00369       <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>* args = <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>(2);
<a name="l00370"></a>00370       args-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[0] = <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstBoolVar.html" title="Boolean variable node.">AstBoolVar</a>(spec-&gt;<a class="code" href="classoperations__research_1_1VarSpec.html#a0e015c6620a90b2f46a405dacdf7a20" title="Variable index.">i</a>);
<a name="l00371"></a>00371       args-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[1] = <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstBoolVar.html" title="Boolean variable node.">AstBoolVar</a>(i);
<a name="l00372"></a>00372       <a class="code" href="classoperations__research_1_1CtSpec.html">CtSpec</a>* <span class="keyword">const</span> alias_ct = <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1CtSpec.html">CtSpec</a>(<a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(),
<a name="l00373"></a>00373                                           <span class="stringliteral">"bool2bool"</span>,
<a name="l00374"></a>00374                                           args,
<a name="l00375"></a>00375                                           NULL);
<a name="l00376"></a>00376       alias_ct-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#9d039c42a4d8965175c98b553debac95">SetDefinedArg</a>(<a class="code" href="classoperations__research_1_1ParserState.html#5f36f047226fd2fa4906a324dea4f0e0">BoolCopy</a>(i));
<a name="l00377"></a>00377       <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.push_back(alias_ct);
<a name="l00378"></a>00378     }
<a name="l00379"></a>00379   }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381   <span class="comment">// Setup mapping structures (constraints per id, and constraints per</span>
<a name="l00382"></a>00382   <span class="comment">// variable).</span>
<a name="l00383"></a>00383   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); i++) {
<a name="l00384"></a>00384     <a class="code" href="classoperations__research_1_1CtSpec.html">CtSpec</a>* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i];
<a name="l00385"></a>00385     <span class="keyword">const</span> <span class="keywordtype">int</span> index = spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#5c76c43846bbb56d7340ac9af68ea208">Index</a>();
<a name="l00386"></a>00386     <span class="keywordflow">if</span> (!spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#4b81df3faa511399839966edfe87bcc1">Nullified</a>()) {
<a name="l00387"></a>00387       constraints_per_id_[spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#b5e09dc7bc835bddd6221a6ec24f88d0">Id</a>()].push_back(index);
<a name="l00388"></a>00388       <span class="keyword">const</span> <span class="keywordtype">int</span> num_args = spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#352aa4b22652c8d3096fa672b99915dd">NumArgs</a>();
<a name="l00389"></a>00389       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; num_args; ++i) {
<a name="l00390"></a>00390         <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> arg = spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#3811d8604a3f7631a1bac0702a5cee40">Arg</a>(i);
<a name="l00391"></a>00391         <span class="keywordflow">if</span> (arg-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#f2abd643d90430d6edd3c0c5ab4f4cee" title="Test if node is an integer variable node.">isIntVar</a>()) {
<a name="l00392"></a>00392           constraints_per_int_variables_[arg-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#ab61375d4213db96ca10dc84b83fc3fd" title="Cast this node to an integer variable node.">getIntVar</a>()].push_back(index);
<a name="l00393"></a>00393         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arg-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#be367494c459b4b2c6d738ac23feed78" title="Test if node is a Boolean variable node.">isBoolVar</a>()) {
<a name="l00394"></a>00394           constraints_per_bool_variables_[arg-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#40d89893961b623de6cf8a40950a264d" title="Cast this node to a Boolean variable node.">getBoolVar</a>()].push_back(index);
<a name="l00395"></a>00395         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arg-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#72542d2c0699a56955a3fad8fdd979b6" title="Test if node is an array node.">isArray</a>()) {
<a name="l00396"></a>00396           <span class="keyword">const</span> std::vector&lt;AstNode*&gt;&amp; array = arg-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#de326d9355b68c1d6b8e33a8521313fd" title="Cast this node to an array node.">getArray</a>()-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>;
<a name="l00397"></a>00397           <span class="keywordflow">for</span> (<span class="keywordtype">int</span> j = 0; j &lt; array.size(); ++j) {
<a name="l00398"></a>00398             <span class="keywordflow">if</span> (array[j]-&gt;isIntVar()) {
<a name="l00399"></a>00399               constraints_per_int_variables_[array[j]-&gt;getIntVar()].push_back(
<a name="l00400"></a>00400                   index);
<a name="l00401"></a>00401             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (array[j]-&gt;isBoolVar()) {
<a name="l00402"></a>00402               constraints_per_bool_variables_[array[j]-&gt;getBoolVar()].push_back(
<a name="l00403"></a>00403                   index);
<a name="l00404"></a>00404             }
<a name="l00405"></a>00405           }
<a name="l00406"></a>00406         }
<a name="l00407"></a>00407       }
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409   }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411   VLOG(1) &lt;&lt; <span class="stringliteral">"Model statistics"</span>;
<a name="l00412"></a>00412   <span class="keywordflow">for</span> (ConstIter&lt;hash_map&lt;<span class="keywordtype">string</span>, std::vector&lt;int&gt; &gt; &gt; it(constraints_per_id_);
<a name="l00413"></a>00413        !it.at_end();
<a name="l00414"></a>00414        ++it) {
<a name="l00415"></a>00415     VLOG(1) &lt;&lt; <span class="stringliteral">"  - "</span> &lt;&lt; it-&gt;first &lt;&lt; <span class="stringliteral">": "</span> &lt;&lt; it-&gt;second.size();
<a name="l00416"></a>00416   }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418   <span class="keywordflow">if</span> (ContainsKey(constraints_per_id_, <span class="stringliteral">"array_bool_or"</span>)) {
<a name="l00419"></a>00419     <span class="keyword">const</span> std::vector&lt;int&gt;&amp; ors = constraints_per_id_[<span class="stringliteral">"array_bool_or"</span>];
<a name="l00420"></a>00420     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; ors.size(); ++i) {
<a name="l00421"></a>00421       Strongify(ors[i]);
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423   }
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 <span class="keywordtype">void</span> ParserState::SortConstraints(<a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>* <span class="keyword">const</span> candidates,
<a name="l00427"></a>00427                                   <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>* <span class="keyword">const</span> computed_variables) {
<a name="l00428"></a>00428 
<a name="l00429"></a>00429   <span class="comment">// Discover expressions, topological sort of constraints.</span>
<a name="l00430"></a>00430 
<a name="l00431"></a>00431   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); i++) {
<a name="l00432"></a>00432     <a class="code" href="classoperations__research_1_1CtSpec.html">CtSpec</a>* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i];
<a name="l00433"></a>00433     ComputeViableTarget(spec, candidates);
<a name="l00434"></a>00434   }
<a name="l00435"></a>00435 
<a name="l00436"></a>00436   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); i++) {
<a name="l00437"></a>00437     CtSpec* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i];
<a name="l00438"></a>00438     ComputeDependencies(*candidates, spec);
<a name="l00439"></a>00439     <span class="keywordflow">if</span> (spec-&gt;DefinedArg() != NULL || !spec-&gt;require_map().empty()) {
<a name="l00440"></a>00440       VLOG(2) &lt;&lt; spec-&gt;DebugString();
<a name="l00441"></a>00441     }
<a name="l00442"></a>00442   }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444   VLOG(1) &lt;&lt; <span class="stringliteral">"Sort constraints"</span>;
<a name="l00445"></a>00445   std::vector&lt;CtSpec*&gt; defines_only;
<a name="l00446"></a>00446   std::vector&lt;CtSpec*&gt; no_defines;
<a name="l00447"></a>00447   std::vector&lt;CtSpec*&gt; defines_and_require;
<a name="l00448"></a>00448   <span class="keywordtype">int</span> nullified = 0;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); i++) {
<a name="l00451"></a>00451     CtSpec* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i];
<a name="l00452"></a>00452     <span class="keywordflow">if</span>(spec-&gt;Nullified()) {
<a name="l00453"></a>00453       nullified++;
<a name="l00454"></a>00454     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (spec-&gt;DefinedArg() != NULL &amp;&amp; spec-&gt;require_map().empty()) {
<a name="l00455"></a>00455       defines_only.push_back(spec);
<a name="l00456"></a>00456     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (spec-&gt;DefinedArg() == NULL) {
<a name="l00457"></a>00457       no_defines.push_back(spec);
<a name="l00458"></a>00458     } <span class="keywordflow">else</span> {
<a name="l00459"></a>00459       defines_and_require.push_back(spec);
<a name="l00460"></a>00460     }
<a name="l00461"></a>00461   }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463   VLOG(1) &lt;&lt; <span class="stringliteral">"  - defines only          : "</span> &lt;&lt; defines_only.size();
<a name="l00464"></a>00464   VLOG(1) &lt;&lt; <span class="stringliteral">"  - no defines            : "</span> &lt;&lt; no_defines.size();
<a name="l00465"></a>00465   VLOG(1) &lt;&lt; <span class="stringliteral">"  - defines and require   : "</span> &lt;&lt; defines_and_require.size();
<a name="l00466"></a>00466   VLOG(1) &lt;&lt; <span class="stringliteral">"  - nullified constraints : "</span> &lt;&lt; nullified;
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   <span class="keyword">const</span> <span class="keywordtype">int</span> size = <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size();
<a name="l00469"></a>00469   <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.clear();
<a name="l00470"></a>00470   <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.resize(size - nullified);
<a name="l00471"></a>00471   <span class="keywordtype">int</span> index = 0;
<a name="l00472"></a>00472   <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a> defined;
<a name="l00473"></a>00473   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; defines_only.size(); ++i) {
<a name="l00474"></a>00474     <span class="keywordflow">if</span> (!defines_only[i]-&gt;Nullified()) {
<a name="l00475"></a>00475       <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[index++] = defines_only[i];
<a name="l00476"></a>00476       defined.insert(<a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(defines_only[i]-&gt;DefinedArg()));
<a name="l00477"></a>00477       VLOG(2) &lt;&lt; <span class="stringliteral">"defined.insert "</span>
<a name="l00478"></a>00478               &lt;&lt; defines_only[i]-&gt;DefinedArg()-&gt;DebugString();
<a name="l00479"></a>00479     }
<a name="l00480"></a>00480   }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482   <span class="comment">// Topological sorting.</span>
<a name="l00483"></a>00483   <a class="code" href="namespaceoperations__research.html#0ae2613f919b7bb9acbccbef94fd3847">ConstraintSet</a> to_insert;
<a name="l00484"></a>00484   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; defines_and_require.size(); ++i) {
<a name="l00485"></a>00485     <span class="keywordflow">if</span> (!defines_and_require[i]-&gt;Nullified()) {
<a name="l00486"></a>00486       to_insert.insert(defines_and_require[i]);
<a name="l00487"></a>00487       VLOG(2) &lt;&lt; <span class="stringliteral">" to_insert "</span> &lt;&lt; defines_and_require[i]-&gt;DebugString();
<a name="l00488"></a>00488     }
<a name="l00489"></a>00489   }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491   <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a> forced;
<a name="l00492"></a>00492   <span class="keywordflow">while</span> (!to_insert.empty()) {
<a name="l00493"></a>00493     std::vector&lt;CtSpec*&gt; inserted;
<a name="l00494"></a>00494     <span class="keywordflow">for</span> (ConstIter&lt;ConstraintSet&gt; it(to_insert); !it.at_end(); ++it) {
<a name="l00495"></a>00495       CtSpec* <span class="keyword">const</span> spec = *it;
<a name="l00496"></a>00496       VLOG(2) &lt;&lt; <span class="stringliteral">"check "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l00497"></a>00497       <span class="keywordflow">if</span> (ContainsKey(forced, spec-&gt;DefinedArg())) {
<a name="l00498"></a>00498         VLOG(2) &lt;&lt; <span class="stringliteral">"  - cleaning defines"</span>;
<a name="l00499"></a>00499         spec-&gt;RemoveDefines();
<a name="l00500"></a>00500       }
<a name="l00501"></a>00501       <span class="keywordtype">bool</span> ok = <span class="keyword">true</span>;
<a name="l00502"></a>00502       <span class="keywordflow">for</span> (ConstIter&lt;NodeSet&gt; def(spec-&gt;require_map()); !def.at_end(); ++def) {
<a name="l00503"></a>00503         <span class="keywordflow">if</span> (!ContainsKey(defined, *def)) {
<a name="l00504"></a>00504           ok = <span class="keyword">false</span>;
<a name="l00505"></a>00505           <span class="keywordflow">break</span>;
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507       }
<a name="l00508"></a>00508       <span class="keywordflow">if</span> (ok) {
<a name="l00509"></a>00509         inserted.push_back(spec);
<a name="l00510"></a>00510         <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[index++] = spec;
<a name="l00511"></a>00511         <span class="keywordflow">if</span> (spec-&gt;DefinedArg() != NULL) {
<a name="l00512"></a>00512           defined.insert(<a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(spec-&gt;DefinedArg()));
<a name="l00513"></a>00513           VLOG(2) &lt;&lt; <span class="stringliteral">"inserted.push_back "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l00514"></a>00514           VLOG(2) &lt;&lt; <span class="stringliteral">"defined.insert "</span> &lt;&lt; spec-&gt;DefinedArg()-&gt;DebugString();
<a name="l00515"></a>00515         }
<a name="l00516"></a>00516       }
<a name="l00517"></a>00517     }
<a name="l00518"></a>00518     <span class="keywordflow">if</span> (inserted.empty()) {
<a name="l00519"></a>00519       <span class="comment">// Recovery mode. We have a cycle!.  Let's find the one</span>
<a name="l00520"></a>00520       <span class="comment">// with the smallest number of unsatisfied dependencies.</span>
<a name="l00521"></a>00521       CtSpec* to_correct = NULL;
<a name="l00522"></a>00522       <span class="keywordtype">int</span> best_unsatisfied = kint32max;
<a name="l00523"></a>00523       <span class="keywordflow">for</span> (ConstIter&lt;ConstraintSet&gt; it(to_insert); !it.at_end(); ++it) {
<a name="l00524"></a>00524         CtSpec* <span class="keyword">const</span> spec = *it;
<a name="l00525"></a>00525         VLOG(2) &lt;&lt; <span class="stringliteral">"evaluate "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l00526"></a>00526 
<a name="l00527"></a>00527         <span class="keywordtype">int</span> unsatisfied = 0;
<a name="l00528"></a>00528         <span class="keyword">const</span> <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>&amp; required = spec-&gt;require_map();
<a name="l00529"></a>00529         <span class="keywordflow">for</span> (ConstIter&lt;NodeSet&gt; def(required); !def.at_end(); ++def) {
<a name="l00530"></a>00530           AstNode* <span class="keyword">const</span> dep = *def;
<a name="l00531"></a>00531           unsatisfied += !ContainsKey(defined, dep);
<a name="l00532"></a>00532           <span class="keywordflow">if</span> (IsAlias(dep)) {
<a name="l00533"></a>00533             VLOG(2) &lt;&lt; <span class="stringliteral">"  - "</span> &lt;&lt; dep-&gt;DebugString()
<a name="l00534"></a>00534                     &lt;&lt; <span class="stringliteral">"is an alias, disqualified"</span>;
<a name="l00535"></a>00535             unsatisfied = kint32max;
<a name="l00536"></a>00536             <span class="keywordflow">break</span>;
<a name="l00537"></a>00537           }
<a name="l00538"></a>00538         }
<a name="l00539"></a>00539         CHECK_GT(unsatisfied, 0);
<a name="l00540"></a>00540         VLOG(2) &lt;&lt; <span class="stringliteral">"  - unsatisfied = "</span> &lt;&lt; unsatisfied;
<a name="l00541"></a>00541         <span class="keywordflow">if</span> (unsatisfied &lt; best_unsatisfied) {
<a name="l00542"></a>00542           best_unsatisfied = unsatisfied;
<a name="l00543"></a>00543           to_correct = spec;
<a name="l00544"></a>00544         }
<a name="l00545"></a>00545       }
<a name="l00546"></a>00546       VLOG(2) &lt;&lt; <span class="stringliteral">"Lifting "</span> &lt;&lt; to_correct-&gt;DebugString()
<a name="l00547"></a>00547               &lt;&lt; <span class="stringliteral">" with "</span> &lt;&lt; best_unsatisfied &lt;&lt; <span class="stringliteral">" unsatisfied dependencies"</span>;
<a name="l00548"></a>00548       <span class="keyword">const</span> <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>&amp; required = to_correct-&gt;require_map();
<a name="l00549"></a>00549       <span class="keywordflow">for</span> (ConstIter&lt;NodeSet&gt; def(required); !def.at_end(); ++def) {
<a name="l00550"></a>00550         AstNode* <span class="keyword">const</span> dep = <a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(*def);
<a name="l00551"></a>00551         <span class="keywordflow">if</span> (!ContainsKey(defined, dep)) {
<a name="l00552"></a>00552           candidates-&gt;erase(dep);
<a name="l00553"></a>00553           defined.insert(dep);
<a name="l00554"></a>00554           forced.insert(dep);
<a name="l00555"></a>00555           VLOG(2) &lt;&lt; <span class="stringliteral">"removing "</span> &lt;&lt; dep-&gt;DebugString()
<a name="l00556"></a>00556                   &lt;&lt; <span class="stringliteral">" from set of candidates and forcing as defined"</span>;
<a name="l00557"></a>00557         }
<a name="l00558"></a>00558       }
<a name="l00559"></a>00559     } <span class="keywordflow">else</span> {
<a name="l00560"></a>00560       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; inserted.size(); ++i) {
<a name="l00561"></a>00561         to_insert.erase(inserted[i]);
<a name="l00562"></a>00562       }
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564   }
<a name="l00565"></a>00565 
<a name="l00566"></a>00566   <span class="comment">// Push the rest.</span>
<a name="l00567"></a>00567   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; no_defines.size(); ++i) {
<a name="l00568"></a>00568     <span class="keywordflow">if</span>(!no_defines[i]-&gt;Nullified()) {
<a name="l00569"></a>00569       <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[index++] = no_defines[i];
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571   }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573   CHECK_EQ(index, size - nullified);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); i++) {
<a name="l00576"></a>00576     CtSpec* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i];
<a name="l00577"></a>00577     VLOG(2) &lt;&lt; i &lt;&lt; <span class="stringliteral">" -&gt; "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l00578"></a>00578     MarkComputedVariables(spec, computed_variables);
<a name="l00579"></a>00579   }
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 <span class="keywordtype">void</span> ParserState::BuildModel(<span class="keyword">const</span> <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>&amp; candidates,
<a name="l00583"></a>00583                              <span class="keyword">const</span> <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a>&amp; computed_variables) {
<a name="l00584"></a>00584   VLOG(1) &lt;&lt; <span class="stringliteral">"Creating variables"</span>;
<a name="l00585"></a>00585 
<a name="l00586"></a>00586   <span class="keywordtype">int</span> array_index = 0;
<a name="l00587"></a>00587   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>.size(); i++) {
<a name="l00588"></a>00588     VLOG(1) &lt;&lt; <span class="stringliteral">"xi("</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">") -&gt; "</span> &lt;&lt; <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[i]-&gt;DebugString();
<a name="l00589"></a>00589     <span class="keywordflow">if</span> (!<a class="code" href="classoperations__research_1_1ParserState.html#162dbbfaa104af4a338457f84fcaeb84">hadError</a>) {
<a name="l00590"></a>00590       <span class="keyword">const</span> std::string&amp; raw_name = <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[i]-&gt;Name();
<a name="l00591"></a>00591       std::string name;
<a name="l00592"></a>00592       <span class="keywordflow">if</span> (raw_name[0] == <span class="charliteral">'['</span>) {
<a name="l00593"></a>00593         name = StringPrintf(<span class="stringliteral">"%s[%d]"</span>, raw_name.c_str() + 1, ++array_index);
<a name="l00594"></a>00594       } <span class="keywordflow">else</span> {
<a name="l00595"></a>00595         <span class="keywordflow">if</span> (array_index == 0) {
<a name="l00596"></a>00596           name = raw_name;
<a name="l00597"></a>00597         } <span class="keywordflow">else</span> {
<a name="l00598"></a>00598           name = StringPrintf(<span class="stringliteral">"%s[%d]"</span>, raw_name.c_str(), array_index + 1);
<a name="l00599"></a>00599           array_index = 0;
<a name="l00600"></a>00600         }
<a name="l00601"></a>00601       }
<a name="l00602"></a>00602       AstNode* <span class="keyword">const</span> var = <a class="code" href="classoperations__research_1_1ParserState.html#7e35c8b6cd4483e4f1aa2de03addf1fe">IntCopy</a>(i);
<a name="l00603"></a>00603       <span class="keywordflow">if</span> (!ContainsKey(candidates, var) &amp;&amp; !ContainsKey(int_aliases_, i)) {
<a name="l00604"></a>00604         <span class="keyword">const</span> <span class="keywordtype">bool</span> active =
<a name="l00605"></a>00605             !IsIntroduced(var) &amp;&amp; !ContainsKey(computed_variables, var);
<a name="l00606"></a>00606         model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#f47b881bfd0c7490f495d0ef4b345cd7" title="Creates a new integer variable from specification.">NewIntVar</a>(name, <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[i], active);
<a name="l00607"></a>00607       } <span class="keywordflow">else</span> {
<a name="l00608"></a>00608         model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#8901ea2adcd0643ed399c4f294e2a84f" title="Skips the creation of the variable.">SkipIntVar</a>();
<a name="l00609"></a>00609         VLOG(1) &lt;&lt; <span class="stringliteral">"  - skipped"</span>;
<a name="l00610"></a>00610         <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[i]-&gt;HasDomain()) {
<a name="l00611"></a>00611           <a class="code" href="classoperations__research_1_1ParserState.html#c5342d3d7d6272ecbcfa79ce4b9f11e6">AddIntVarDomainConstraint</a>(i, <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[i]-&gt;Domain()-&gt;<a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>());
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613       }
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615   }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617   array_index = 0;
<a name="l00618"></a>00618   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>.size(); i++) {
<a name="l00619"></a>00619     AstNode* <span class="keyword">const</span> var = <a class="code" href="classoperations__research_1_1ParserState.html#5f36f047226fd2fa4906a324dea4f0e0">BoolCopy</a>(i);
<a name="l00620"></a>00620     VLOG(1) &lt;&lt; var-&gt;DebugString() &lt;&lt; <span class="stringliteral">" -&gt; "</span>
<a name="l00621"></a>00621             &lt;&lt; <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>[i]-&gt;DebugString();
<a name="l00622"></a>00622     <span class="keywordflow">if</span> (!<a class="code" href="classoperations__research_1_1ParserState.html#162dbbfaa104af4a338457f84fcaeb84">hadError</a>) {
<a name="l00623"></a>00623       <span class="keyword">const</span> std::string&amp; raw_name = <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>[i]-&gt;Name();
<a name="l00624"></a>00624       std::string name;
<a name="l00625"></a>00625       <span class="keywordflow">if</span> (raw_name[0] == <span class="charliteral">'['</span>) {
<a name="l00626"></a>00626         name = StringPrintf(<span class="stringliteral">"%s[%d]"</span>, raw_name.c_str() + 1, ++array_index);
<a name="l00627"></a>00627       } <span class="keywordflow">else</span> {
<a name="l00628"></a>00628         <span class="keywordflow">if</span> (array_index == 0) {
<a name="l00629"></a>00629           name = raw_name;
<a name="l00630"></a>00630         } <span class="keywordflow">else</span> {
<a name="l00631"></a>00631           name = StringPrintf(<span class="stringliteral">"%s[%d]"</span>, raw_name.c_str(), array_index + 1);
<a name="l00632"></a>00632           array_index = 0;
<a name="l00633"></a>00633         }
<a name="l00634"></a>00634       }
<a name="l00635"></a>00635       <span class="keywordflow">if</span> (!ContainsKey(candidates, var)) {
<a name="l00636"></a>00636         model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#f211047ea0fc7f4a328c5a1b01e8031d" title="Creates a new boolean variable from specification.">NewBoolVar</a>(name, <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>[i]);
<a name="l00637"></a>00637       } <span class="keywordflow">else</span> {
<a name="l00638"></a>00638         model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#9817ff1575ee1f3056d5e915037aa25e" title="Skips the creation of the variable.">SkipBoolVar</a>();
<a name="l00639"></a>00639         VLOG(1) &lt;&lt; <span class="stringliteral">"  - skipped"</span>;
<a name="l00640"></a>00640       }
<a name="l00641"></a>00641     }
<a name="l00642"></a>00642   }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644   array_index = 0;
<a name="l00645"></a>00645   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#b25b9ef5be1cf155545ea830fd7f2387">set_variables_</a>.size(); i++) {
<a name="l00646"></a>00646     <span class="keywordflow">if</span> (!<a class="code" href="classoperations__research_1_1ParserState.html#162dbbfaa104af4a338457f84fcaeb84">hadError</a>) {
<a name="l00647"></a>00647       <span class="keyword">const</span> std::string&amp; raw_name = <a class="code" href="classoperations__research_1_1ParserState.html#b25b9ef5be1cf155545ea830fd7f2387">set_variables_</a>[i]-&gt;Name();
<a name="l00648"></a>00648       std::string name;
<a name="l00649"></a>00649       <span class="keywordflow">if</span> (raw_name[0] == <span class="charliteral">'['</span>) {
<a name="l00650"></a>00650         name = StringPrintf(<span class="stringliteral">"%s[%d]"</span>, raw_name.c_str() + 1, ++array_index);
<a name="l00651"></a>00651       } <span class="keywordflow">else</span> {
<a name="l00652"></a>00652         <span class="keywordflow">if</span> (array_index == 0) {
<a name="l00653"></a>00653           name = raw_name;
<a name="l00654"></a>00654         } <span class="keywordflow">else</span> {
<a name="l00655"></a>00655           name = StringPrintf(<span class="stringliteral">"%s[%d]"</span>, raw_name.c_str(), array_index + 1);
<a name="l00656"></a>00656           array_index = 0;
<a name="l00657"></a>00657         }
<a name="l00658"></a>00658       }
<a name="l00659"></a>00659       model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#9a549233266a6d9cb339df4cd4e6f450" title="Creates a new set variable from specification.">NewSetVar</a>(name, <a class="code" href="classoperations__research_1_1ParserState.html#b25b9ef5be1cf155545ea830fd7f2387">set_variables_</a>[i]);
<a name="l00660"></a>00660     }
<a name="l00661"></a>00661   }
<a name="l00662"></a>00662 
<a name="l00663"></a>00663   VLOG(1) &lt;&lt; <span class="stringliteral">"Creating constraints"</span>;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(); i++) {
<a name="l00666"></a>00666     <span class="keywordflow">if</span> (!<a class="code" href="classoperations__research_1_1ParserState.html#162dbbfaa104af4a338457f84fcaeb84">hadError</a>) {
<a name="l00667"></a>00667       CtSpec* <span class="keyword">const</span> spec = <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i];
<a name="l00668"></a>00668       VLOG(1) &lt;&lt; <span class="stringliteral">"Constraint "</span> &lt;&lt; <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i]-&gt;DebugString();
<a name="l00669"></a>00669       model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#e2329963fe72dd1d920c6279d5b88ecb" title="Post a constraint specified by ce.">PostConstraint</a>(<a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>[i]);
<a name="l00670"></a>00670     }
<a name="l00671"></a>00671   }
<a name="l00672"></a>00672 
<a name="l00673"></a>00673   VLOG(1) &lt;&lt; <span class="stringliteral">"Populating aliases"</span>;
<a name="l00674"></a>00674   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>.size(); ++i) {
<a name="l00675"></a>00675     <span class="keywordflow">if</span> (ContainsKey(int_aliases_, i)) {
<a name="l00676"></a>00676       IntExpr* <span class="keyword">const</span> expr = model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#5c0c0354f67a5350a7cea5cdbd5c5fdd">GetIntExpr</a>(<a class="code" href="classoperations__research_1_1ParserState.html#7e35c8b6cd4483e4f1aa2de03addf1fe">IntCopy</a>(int_aliases_[i]));
<a name="l00677"></a>00677       CHECK(expr != NULL);
<a name="l00678"></a>00678       model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#e5521378b58b4fb7b30ed42ba1c78127">CheckIntegerVariableIsNull</a>(<a class="code" href="classoperations__research_1_1ParserState.html#7e35c8b6cd4483e4f1aa2de03addf1fe">IntCopy</a>(i));
<a name="l00679"></a>00679       model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#380665a36b946ba87273511d7261fd34">SetIntegerExpression</a>(<a class="code" href="classoperations__research_1_1ParserState.html#7e35c8b6cd4483e4f1aa2de03addf1fe">IntCopy</a>(i), expr);
<a name="l00680"></a>00680       VLOG(1) &lt;&lt; <span class="stringliteral">"  - setting x("</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">") to be "</span> &lt;&lt; expr-&gt;DebugString();
<a name="l00681"></a>00681     }
<a name="l00682"></a>00682   }
<a name="l00683"></a>00683 
<a name="l00684"></a>00684   VLOG(1) &lt;&lt; <span class="stringliteral">"Adding domain constraints"</span>;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = <a class="code" href="classoperations__research_1_1ParserState.html#627c907b2095e594d29c34ee12ec4492">int_domain_constraints_</a>.size(); i--;) {
<a name="l00687"></a>00687     <span class="keywordflow">if</span> (!<a class="code" href="classoperations__research_1_1ParserState.html#162dbbfaa104af4a338457f84fcaeb84">hadError</a>) {
<a name="l00688"></a>00688       AstNode* <span class="keyword">const</span> var_node = <a class="code" href="classoperations__research_1_1ParserState.html#627c907b2095e594d29c34ee12ec4492">int_domain_constraints_</a>[i].first;
<a name="l00689"></a>00689       IntVar* <span class="keyword">const</span> var = model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#5c0c0354f67a5350a7cea5cdbd5c5fdd">GetIntExpr</a>(var_node)-&gt;Var();
<a name="l00690"></a>00690       AstSetLit* <span class="keyword">const</span> dom = <a class="code" href="classoperations__research_1_1ParserState.html#627c907b2095e594d29c34ee12ec4492">int_domain_constraints_</a>[i].second;
<a name="l00691"></a>00691       <span class="keywordflow">if</span> (dom-&gt;interval &amp;&amp; (dom-&gt;imin &gt; var-&gt;Min() || dom-&gt;imax &lt; var-&gt;Max())) {
<a name="l00692"></a>00692         VLOG(1) &lt;&lt; <span class="stringliteral">"Reduce integer variable "</span> &lt;&lt; var-&gt;DebugString()
<a name="l00693"></a>00693                 &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; dom-&gt;DebugString();
<a name="l00694"></a>00694         var-&gt;SetRange(dom-&gt;imin, dom-&gt;imax);
<a name="l00695"></a>00695       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!dom-&gt;interval) {
<a name="l00696"></a>00696         VLOG(1) &lt;&lt; <span class="stringliteral">"Reduce integer variable "</span> &lt;&lt; var-&gt;DebugString()
<a name="l00697"></a>00697                 &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; dom-&gt;DebugString();
<a name="l00698"></a>00698         var-&gt;SetValues(dom-&gt;s);
<a name="l00699"></a>00699       }
<a name="l00700"></a>00700     }
<a name="l00701"></a>00701   }
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a><a class="code" href="classoperations__research_1_1ParserState.html#b3c81faf8c201541e9db707b10b7f484">00704</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1ParserState.html#b3c81faf8c201541e9db707b10b7f484">ParserState::AnalyseAndCreateModel</a>() {
<a name="l00705"></a>00705   model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#ae83add5e1bc49212d2292d324dccde9">InitSolver</a>();
<a name="l00706"></a>00706   <a class="code" href="classoperations__research_1_1ParserState.html#7f38a3cfd87a0e2766166cdac6f69595">Presolve</a>();
<a name="l00707"></a>00707   <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a> candidates;
<a name="l00708"></a>00708   <a class="code" href="namespaceoperations__research.html#948e87fb465470163b0cbb98195b4fdd">NodeSet</a> computed_variables;
<a name="l00709"></a>00709   SortConstraints(&amp;candidates, &amp;computed_variables);
<a name="l00710"></a>00710   BuildModel(candidates, computed_variables);
<a name="l00711"></a>00711 }
<a name="l00712"></a>00712 
<a name="l00713"></a><a class="code" href="classoperations__research_1_1ParserState.html#af962ff6f82f0b021fe127cc3dbe6821">00713</a> <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <a class="code" href="classoperations__research_1_1ParserState.html#af962ff6f82f0b021fe127cc3dbe6821">ParserState::ArrayElement</a>(<span class="keywordtype">string</span> <span class="keywordtype">id</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset) {
<a name="l00714"></a>00714   <span class="keywordflow">if</span> (offset &gt; 0) {
<a name="l00715"></a>00715     vector&lt;int64&gt; tmp;
<a name="l00716"></a>00716     <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#d110c56d1796b2236992bd2e4483ca42">int_var_array_map_</a>.<a class="code" href="classoperations__research_1_1SymbolTable.html#83417fa51e40942268603621306feae3" title="Return whether key exists, and set val if it does exist.">get</a>(<span class="keywordtype">id</span>, tmp) &amp;&amp; offset&lt;=tmp.size())
<a name="l00717"></a>00717       <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstIntVar.html" title="Integer variable node.">AstIntVar</a>(tmp[offset-1]);
<a name="l00718"></a>00718     <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#924d3e3e4e48c45eea6799d67deebe13">bool_var_array_map_</a>.<a class="code" href="classoperations__research_1_1SymbolTable.html#83417fa51e40942268603621306feae3" title="Return whether key exists, and set val if it does exist.">get</a>(<span class="keywordtype">id</span>, tmp) &amp;&amp; offset&lt;=tmp.size())
<a name="l00719"></a>00719       <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstBoolVar.html" title="Boolean variable node.">AstBoolVar</a>(tmp[offset-1]);
<a name="l00720"></a>00720     <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#23373817a512484f18782a7be8748944">set_var_array_map_</a>.<a class="code" href="classoperations__research_1_1SymbolTable.html#83417fa51e40942268603621306feae3" title="Return whether key exists, and set val if it does exist.">get</a>(<span class="keywordtype">id</span>, tmp) &amp;&amp; offset&lt;=tmp.size())
<a name="l00721"></a>00721       <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstSetVar.html" title="Set variable node">AstSetVar</a>(tmp[offset-1]);
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#49f6a7d10b7f102c4067f2b5f34cae87">int_value_array_map_</a>.<a class="code" href="classoperations__research_1_1SymbolTable.html#83417fa51e40942268603621306feae3" title="Return whether key exists, and set val if it does exist.">get</a>(<span class="keywordtype">id</span>, tmp) &amp;&amp; offset&lt;=tmp.size())
<a name="l00724"></a>00724       <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstIntLit.html" title="Integer literal node.">AstIntLit</a>(tmp[offset-1]);
<a name="l00725"></a>00725     <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#4ee7264834fb128c13b1b3d95472d225">bool_value_array_map_</a>.<a class="code" href="classoperations__research_1_1SymbolTable.html#83417fa51e40942268603621306feae3" title="Return whether key exists, and set val if it does exist.">get</a>(<span class="keywordtype">id</span>, tmp) &amp;&amp; offset&lt;=tmp.size())
<a name="l00726"></a>00726       <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstBoolLit.html" title="Boolean literal node.">AstBoolLit</a>(tmp[offset-1]);
<a name="l00727"></a>00727     vector&lt;AstSetLit&gt; tmpS;
<a name="l00728"></a>00728     <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#0a579ea6d2de35c7d2a24bc852f176a8">set_value_array_map_</a>.get(<span class="keywordtype">id</span>, tmpS) &amp;&amp; offset&lt;=tmpS.size())
<a name="l00729"></a>00729       <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstSetLit.html" title="Set literal node">AstSetLit</a>(tmpS[offset-1]);
<a name="l00730"></a>00730   }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732   LOG(ERROR) &lt;&lt; <span class="stringliteral">"Error: array access to "</span> &lt;&lt; <span class="keywordtype">id</span> &lt;&lt; <span class="stringliteral">" invalid"</span>
<a name="l00733"></a>00733              &lt;&lt; <span class="stringliteral">" in line no. "</span> &lt;&lt; <a class="code" href="lexer_8win_8cc.html#86cef2b171b5abc4f80a9d55b839e7c2" title="Get the current line number.">yyget_lineno</a>(<a class="code" href="classoperations__research_1_1ParserState.html#934483fb2026744b2d9b34b2c9373dce">yyscanner</a>);
<a name="l00734"></a>00734   <a class="code" href="classoperations__research_1_1ParserState.html#162dbbfaa104af4a338457f84fcaeb84">hadError</a> = <span class="keyword">true</span>;
<a name="l00735"></a>00735   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstIntVar.html" title="Integer variable node.">AstIntVar</a>(0); <span class="comment">// keep things consistent</span>
<a name="l00736"></a>00736 }
<a name="l00737"></a>00737 
<a name="l00738"></a><a class="code" href="classoperations__research_1_1ParserState.html#c3de8a764fb4d5f2ba24ff2360137870">00738</a> <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <a class="code" href="classoperations__research_1_1ParserState.html#c3de8a764fb4d5f2ba24ff2360137870">ParserState::VarRefArg</a>(<span class="keywordtype">string</span> <span class="keywordtype">id</span>, <span class="keywordtype">bool</span> annotation) {
<a name="l00739"></a>00739   int64 tmp;
<a name="l00740"></a>00740   <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#513878dafb233bdf94fba6f0d718b591">int_var_map_</a>.<a class="code" href="classoperations__research_1_1SymbolTable.html#83417fa51e40942268603621306feae3" title="Return whether key exists, and set val if it does exist.">get</a>(<span class="keywordtype">id</span>, tmp))
<a name="l00741"></a>00741     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstIntVar.html" title="Integer variable node.">AstIntVar</a>(tmp);
<a name="l00742"></a>00742   <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#f99b46e5e7a985e48e28cb49622f3e87">bool_var_map_</a>.<a class="code" href="classoperations__research_1_1SymbolTable.html#83417fa51e40942268603621306feae3" title="Return whether key exists, and set val if it does exist.">get</a>(<span class="keywordtype">id</span>, tmp))
<a name="l00743"></a>00743     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstBoolVar.html" title="Boolean variable node.">AstBoolVar</a>(tmp);
<a name="l00744"></a>00744   <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#f6a6d89234b38cbe489df0807fba6476">set_var_map_</a>.<a class="code" href="classoperations__research_1_1SymbolTable.html#83417fa51e40942268603621306feae3" title="Return whether key exists, and set val if it does exist.">get</a>(<span class="keywordtype">id</span>, tmp))
<a name="l00745"></a>00745     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstSetVar.html" title="Set variable node">AstSetVar</a>(tmp);
<a name="l00746"></a>00746   <span class="keywordflow">if</span> (annotation)
<a name="l00747"></a>00747     <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstAtom.html" title="Node representing an atom">AstAtom</a>(<span class="keywordtype">id</span>);
<a name="l00748"></a>00748   LOG(ERROR) &lt;&lt; <span class="stringliteral">"Error: undefined variable "</span> &lt;&lt; <span class="keywordtype">id</span>
<a name="l00749"></a>00749              &lt;&lt; <span class="stringliteral">" in line no. "</span> &lt;&lt; <a class="code" href="lexer_8win_8cc.html#86cef2b171b5abc4f80a9d55b839e7c2" title="Get the current line number.">yyget_lineno</a>(<a class="code" href="classoperations__research_1_1ParserState.html#934483fb2026744b2d9b34b2c9373dce">yyscanner</a>);
<a name="l00750"></a>00750   <a class="code" href="classoperations__research_1_1ParserState.html#162dbbfaa104af4a338457f84fcaeb84">hadError</a> = <span class="keyword">true</span>;
<a name="l00751"></a>00751   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstIntVar.html" title="Integer variable node.">AstIntVar</a>(0); <span class="comment">// keep things consistent</span>
<a name="l00752"></a>00752 }
<a name="l00753"></a>00753 
<a name="l00754"></a><a class="code" href="classoperations__research_1_1ParserState.html#c5342d3d7d6272ecbcfa79ce4b9f11e6">00754</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1ParserState.html#c5342d3d7d6272ecbcfa79ce4b9f11e6">ParserState::AddIntVarDomainConstraint</a>(<span class="keywordtype">int</span> var_id,
<a name="l00755"></a>00755                                             <a class="code" href="classoperations__research_1_1AstSetLit.html" title="Set literal node">AstSetLit</a>* <span class="keyword">const</span> dom) {
<a name="l00756"></a>00756   <span class="keywordflow">if</span> (dom != NULL) {
<a name="l00757"></a>00757     VLOG(1) &lt;&lt; <span class="stringliteral">"  - adding int var domain constraint ("</span> &lt;&lt; var_id
<a name="l00758"></a>00758             &lt;&lt; <span class="stringliteral">") : "</span> &lt;&lt; dom-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#60b2ba8dc1e35192b131cb71db5eb631" title="Output string representation.">DebugString</a>();
<a name="l00759"></a>00759     <a class="code" href="classoperations__research_1_1ParserState.html#627c907b2095e594d29c34ee12ec4492">int_domain_constraints_</a>.push_back(
<a name="l00760"></a>00760         std::make_pair(<span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstIntVar.html" title="Integer variable node.">AstIntVar</a>(var_id), dom));
<a name="l00761"></a>00761   }
<a name="l00762"></a>00762 }
<a name="l00763"></a>00763 
<a name="l00764"></a><a class="code" href="classoperations__research_1_1ParserState.html#2ac67bf73a15eb6dac8ca5ca1043903d">00764</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1ParserState.html#2ac67bf73a15eb6dac8ca5ca1043903d">ParserState::AddBoolVarDomainConstraint</a>(<span class="keywordtype">int</span> var_id,
<a name="l00765"></a>00765                                              <a class="code" href="classoperations__research_1_1AstSetLit.html" title="Set literal node">AstSetLit</a>* <span class="keyword">const</span> dom) {
<a name="l00766"></a>00766   <span class="keywordflow">if</span> (dom != NULL) {
<a name="l00767"></a>00767     VLOG(1) &lt;&lt; <span class="stringliteral">"  - adding bool var domain constraint ("</span> &lt;&lt; var_id
<a name="l00768"></a>00768             &lt;&lt; <span class="stringliteral">") : "</span> &lt;&lt; dom-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#60b2ba8dc1e35192b131cb71db5eb631" title="Output string representation.">DebugString</a>();
<a name="l00769"></a>00769     <a class="code" href="classoperations__research_1_1ParserState.html#627c907b2095e594d29c34ee12ec4492">int_domain_constraints_</a>.push_back(
<a name="l00770"></a>00770         std::make_pair(<span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstBoolVar.html" title="Boolean variable node.">AstBoolVar</a>(var_id), dom));
<a name="l00771"></a>00771   }
<a name="l00772"></a>00772 }
<a name="l00773"></a>00773 
<a name="l00774"></a><a class="code" href="classoperations__research_1_1ParserState.html#3e58cbb8598c677bbdb30e05ede1e483">00774</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1ParserState.html#3e58cbb8598c677bbdb30e05ede1e483">ParserState::AddSetVarDomainConstraint</a>(<span class="keywordtype">int</span> var_id,
<a name="l00775"></a>00775                                             <a class="code" href="classoperations__research_1_1AstSetLit.html" title="Set literal node">AstSetLit</a>* <span class="keyword">const</span> dom) {
<a name="l00776"></a>00776   <span class="keywordflow">if</span> (dom != NULL) {
<a name="l00777"></a>00777     VLOG(1) &lt;&lt; <span class="stringliteral">"  - adding set var domain constraint ("</span> &lt;&lt; var_id
<a name="l00778"></a>00778             &lt;&lt; <span class="stringliteral">") : "</span> &lt;&lt; dom-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#60b2ba8dc1e35192b131cb71db5eb631" title="Output string representation.">DebugString</a>();
<a name="l00779"></a>00779     <a class="code" href="classoperations__research_1_1ParserState.html#3dca683efc12319c075376b81712d5f2">set_domain_constraints_</a>.push_back(std::make_pair(var_id, dom));
<a name="l00780"></a>00780   }
<a name="l00781"></a>00781 }
<a name="l00782"></a>00782 
<a name="l00783"></a>00783 <a class="code" href="classoperations__research_1_1IntVarSpec.html" title="Specification for integer variables.">IntVarSpec</a>* ParserState::IntSpec(<a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> node)<span class="keyword"> const </span>{
<a name="l00784"></a>00784   <span class="keywordtype">int</span> index = node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#ab61375d4213db96ca10dc84b83fc3fd" title="Cast this node to an integer variable node.">getIntVar</a>();
<a name="l00785"></a>00785   <span class="keywordflow">while</span> (<a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[index]-&gt;alias) {
<a name="l00786"></a>00786     index = <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[index]-&gt;i;
<a name="l00787"></a>00787   }
<a name="l00788"></a>00788   <span class="keywordflow">return</span> <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[index];
<a name="l00789"></a>00789 }
<a name="l00790"></a>00790 
<a name="l00791"></a><a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">00791</a> <span class="keywordtype">bool</span> <a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">ParserState::IsBound</a>(<a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> node)<span class="keyword"> const </span>{
<a name="l00792"></a>00792   <span class="keywordflow">return</span> node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#a8e1174fcd71dc8250fcf57d14c22110" title="Test if node is int, if yes set i to the value.">isInt</a>() ||
<a name="l00793"></a>00793       (node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#f2abd643d90430d6edd3c0c5ab4f4cee" title="Test if node is an integer variable node.">isIntVar</a>() &amp;&amp; IntSpec(node)-&gt;<a class="code" href="classoperations__research_1_1IntVarSpec.html#b72f6170ccc378c5c6952da54bcae3c1">IsBound</a>()) ||
<a name="l00794"></a>00794       node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#2d7a39334d92d2c9b78b583e08ad3667" title="Test if node is a Boolean node.">isBool</a>() ||
<a name="l00795"></a>00795       (node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#be367494c459b4b2c6d738ac23feed78" title="Test if node is a Boolean variable node.">isBoolVar</a>() &amp;&amp; <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>[node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#40d89893961b623de6cf8a40950a264d" title="Cast this node to a Boolean variable node.">getBoolVar</a>()]-&gt;IsBound());
<a name="l00796"></a>00796 }
<a name="l00797"></a>00797 
<a name="l00798"></a>00798 <span class="keywordtype">bool</span> ParserState::IsIntroduced(<a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> node)<span class="keyword"> const </span>{
<a name="l00799"></a>00799   <span class="keywordflow">return</span> (node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#f2abd643d90430d6edd3c0c5ab4f4cee" title="Test if node is an integer variable node.">isIntVar</a>() &amp;&amp; <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#ab61375d4213db96ca10dc84b83fc3fd" title="Cast this node to an integer variable node.">getIntVar</a>()]-&gt;introduced) ||
<a name="l00800"></a>00800       (node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#be367494c459b4b2c6d738ac23feed78" title="Test if node is a Boolean variable node.">isBoolVar</a>() &amp;&amp; <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>[node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#40d89893961b623de6cf8a40950a264d" title="Cast this node to a Boolean variable node.">getBoolVar</a>()]-&gt;introduced);
<a name="l00801"></a>00801 }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 <span class="keywordtype">bool</span> ParserState::IsAlias(AstNode* <span class="keyword">const</span> node)<span class="keyword"> const </span>{
<a name="l00804"></a>00804   <span class="keywordflow">if</span> (node-&gt;isIntVar()) {
<a name="l00805"></a>00805     <span class="keywordflow">return</span> <a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>[node-&gt;getIntVar()]-&gt;alias;
<a name="l00806"></a>00806   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (node-&gt;isBoolVar()) {
<a name="l00807"></a>00807     <span class="keywordflow">return</span> <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>[node-&gt;getBoolVar()]-&gt;alias;
<a name="l00808"></a>00808   }
<a name="l00809"></a>00809   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00810"></a>00810 }
<a name="l00811"></a>00811 
<a name="l00812"></a><a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">00812</a> <span class="keywordtype">int</span> <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">ParserState::GetBound</a>(<a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> node)<span class="keyword"> const </span>{
<a name="l00813"></a>00813   <span class="keywordflow">if</span> (node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#a8e1174fcd71dc8250fcf57d14c22110" title="Test if node is int, if yes set i to the value.">isInt</a>()) {
<a name="l00814"></a>00814     <span class="keywordflow">return</span> node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#82f72eb772fa55a97938dac93d99a3e4" title="Cast this node to an integer node.">getInt</a>();
<a name="l00815"></a>00815   }
<a name="l00816"></a>00816   <span class="keywordflow">if</span> (node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#f2abd643d90430d6edd3c0c5ab4f4cee" title="Test if node is an integer variable node.">isIntVar</a>()) {
<a name="l00817"></a>00817     <span class="keywordflow">return</span> IntSpec(node)-&gt;<a class="code" href="classoperations__research_1_1IntVarSpec.html#3793987964c9f61ccfb6b1934ee137b1">GetBound</a>();
<a name="l00818"></a>00818   }
<a name="l00819"></a>00819   <span class="keywordflow">if</span> (node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#2d7a39334d92d2c9b78b583e08ad3667" title="Test if node is a Boolean node.">isBool</a>()) {
<a name="l00820"></a>00820     <span class="keywordflow">return</span> node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#f0567eb5be0c9a72409d5cdeaa35bc7e" title="Cast this node to a Boolean node.">getBool</a>();
<a name="l00821"></a>00821   }
<a name="l00822"></a>00822   <span class="keywordflow">if</span> (node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#be367494c459b4b2c6d738ac23feed78" title="Test if node is a Boolean variable node.">isBoolVar</a>()) {
<a name="l00823"></a>00823     <span class="keywordflow">return</span> <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>[node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#40d89893961b623de6cf8a40950a264d" title="Cast this node to a Boolean variable node.">getBoolVar</a>()]-&gt;GetBound();
<a name="l00824"></a>00824   }
<a name="l00825"></a>00825   <span class="keywordflow">return</span> 0;
<a name="l00826"></a>00826 }
<a name="l00827"></a>00827 
<a name="l00828"></a><a class="code" href="classoperations__research_1_1ParserState.html#12acd48dbdaed090b19b8d54025f38fc">00828</a> <span class="keywordtype">bool</span> <a class="code" href="classoperations__research_1_1ParserState.html#12acd48dbdaed090b19b8d54025f38fc">ParserState::IsAllDifferent</a>(<a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> node)<span class="keyword"> const </span>{
<a name="l00829"></a>00829   <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>* <span class="keyword">const</span> array_variables = node-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#de326d9355b68c1d6b8e33a8521313fd" title="Cast this node to an array node.">getArray</a>();
<a name="l00830"></a>00830   <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_variables-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>.size();
<a name="l00831"></a>00831   std::vector&lt;int&gt; variables(size);
<a name="l00832"></a>00832   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l00833"></a>00833     <span class="keywordflow">if</span> (array_variables-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[i]-&gt;isIntVar()) {
<a name="l00834"></a>00834       <span class="keyword">const</span> <span class="keywordtype">int</span> var = array_variables-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[i]-&gt;getIntVar();
<a name="l00835"></a>00835       variables[i] = var;
<a name="l00836"></a>00836     } <span class="keywordflow">else</span> {
<a name="l00837"></a>00837       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00838"></a>00838     }
<a name="l00839"></a>00839   }
<a name="l00840"></a>00840   std::sort(variables.begin(), variables.end());
<a name="l00841"></a>00841 
<a name="l00842"></a>00842   <span class="comment">// Naive.</span>
<a name="l00843"></a>00843   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; all_differents_.size(); ++i) {
<a name="l00844"></a>00844     <span class="keyword">const</span> std::vector&lt;int&gt;&amp; v = all_differents_[i];
<a name="l00845"></a>00845     <span class="keywordflow">if</span> (v.size() != size) {
<a name="l00846"></a>00846       <span class="keywordflow">continue</span>;
<a name="l00847"></a>00847     }
<a name="l00848"></a>00848     <span class="keywordtype">bool</span> ok = <span class="keyword">true</span>;
<a name="l00849"></a>00849     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l00850"></a>00850       <span class="keywordflow">if</span> (v[i] != variables[i]) {
<a name="l00851"></a>00851         ok = <span class="keyword">false</span>;
<a name="l00852"></a>00852         <span class="keywordflow">continue</span>;
<a name="l00853"></a>00853       }
<a name="l00854"></a>00854     }
<a name="l00855"></a>00855     <span class="keywordflow">if</span> (ok) {
<a name="l00856"></a>00856       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00857"></a>00857     }
<a name="l00858"></a>00858   }
<a name="l00859"></a>00859   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
<a name="l00862"></a><a class="code" href="classoperations__research_1_1ParserState.html#5a5475004786923ae85b7ec5b8084442">00862</a> <span class="keywordtype">bool</span> <a class="code" href="classoperations__research_1_1ParserState.html#5a5475004786923ae85b7ec5b8084442">ParserState::MergeIntDomain</a>(<a class="code" href="classoperations__research_1_1IntVarSpec.html" title="Specification for integer variables.">IntVarSpec</a>* <span class="keyword">const</span> source,
<a name="l00863"></a>00863                                  <a class="code" href="classoperations__research_1_1IntVarSpec.html" title="Specification for integer variables.">IntVarSpec</a>* <span class="keyword">const</span> dest) {
<a name="l00864"></a>00864   VLOG(1) &lt;&lt; <span class="stringliteral">"    - merge "</span> &lt;&lt; dest-&gt;<a class="code" href="classoperations__research_1_1IntVarSpec.html#4e68922982dee687ca5b05a388bf6102" title="Debug string.">DebugString</a>() &lt;&lt; <span class="stringliteral">" with "</span>
<a name="l00865"></a>00865           &lt;&lt; source-&gt;<a class="code" href="classoperations__research_1_1IntVarSpec.html#4e68922982dee687ca5b05a388bf6102" title="Debug string.">DebugString</a>();
<a name="l00866"></a>00866   <span class="keywordflow">if</span> (source-&gt;<a class="code" href="classoperations__research_1_1VarSpec.html#b06a367ab2828d25ac2a4f1fa0f96f13" title="Whether the variable is assigned.">assigned</a>) {
<a name="l00867"></a>00867     <span class="keywordflow">return</span> dest-&gt;<a class="code" href="classoperations__research_1_1IntVarSpec.html#bc198689ce6cfce6064cf8a764e2cc83">MergeBounds</a>(source-&gt;<a class="code" href="classoperations__research_1_1VarSpec.html#a0e015c6620a90b2f46a405dacdf7a20" title="Variable index.">i</a>, source-&gt;<a class="code" href="classoperations__research_1_1VarSpec.html#a0e015c6620a90b2f46a405dacdf7a20" title="Variable index.">i</a>);
<a name="l00868"></a>00868   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (source-&gt;<a class="code" href="classoperations__research_1_1IntVarSpec.html#33efa9eb05364d1d968a42a119b64b65">HasDomain</a>()) {
<a name="l00869"></a>00869     <a class="code" href="classoperations__research_1_1AstSetLit.html" title="Set literal node">AstSetLit</a>* <span class="keyword">const</span> domain = source-&gt;<a class="code" href="classoperations__research_1_1IntVarSpec.html#3705ca0502c05cd6340a66f28c7cb8d5">Domain</a>();
<a name="l00870"></a>00870     <span class="keywordflow">if</span> (domain-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#b1f3e7a964661a8cdc95e4da9f38d033">interval</a>) {
<a name="l00871"></a>00871       <span class="keywordflow">return</span> dest-&gt;<a class="code" href="classoperations__research_1_1IntVarSpec.html#bc198689ce6cfce6064cf8a764e2cc83">MergeBounds</a>(domain-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#cc6211973a92c4711637c205c1aaacae">imin</a>, domain-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#7065f4f6a852778871d4a30cf478376a">imax</a>);
<a name="l00872"></a>00872     } <span class="keywordflow">else</span> {
<a name="l00873"></a>00873       <span class="keywordflow">return</span> dest-&gt;<a class="code" href="classoperations__research_1_1IntVarSpec.html#3b4759070090f40582ab5151bda35662">MergeDomain</a>(domain-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#70658e37c7d9deb940af34cdd5f84add">s</a>);
<a name="l00874"></a>00874     }
<a name="l00875"></a>00875   }
<a name="l00876"></a>00876   <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00877"></a>00877 }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879 <span class="keywordtype">bool</span> ParserState::DiscoverAliases(<a class="code" href="classoperations__research_1_1CtSpec.html">CtSpec</a>* <span class="keyword">const</span> spec) {
<a name="l00880"></a>00880   <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; <span class="keywordtype">id</span> = spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#b5e09dc7bc835bddd6221a6ec24f88d0">Id</a>();
<a name="l00881"></a>00881   <span class="keyword">const</span> <span class="keywordtype">int</span> index = spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#5c76c43846bbb56d7340ac9af68ea208">Index</a>();
<a name="l00882"></a>00882   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_eq"</span>) {
<a name="l00883"></a>00883     <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#3811d8604a3f7631a1bac0702a5cee40">Arg</a>(0)-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#f2abd643d90430d6edd3c0c5ab4f4cee" title="Test if node is an integer variable node.">isIntVar</a>() &amp;&amp;
<a name="l00884"></a>00884         spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#3811d8604a3f7631a1bac0702a5cee40">Arg</a>(1)-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#f2abd643d90430d6edd3c0c5ab4f4cee" title="Test if node is an integer variable node.">isIntVar</a>() &amp;&amp;
<a name="l00885"></a>00885         !ContainsKey(stored_constraints_, spec)) {
<a name="l00886"></a>00886       <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> var0 = <a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#3811d8604a3f7631a1bac0702a5cee40">Arg</a>(0));
<a name="l00887"></a>00887       <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> var1 = <a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#3811d8604a3f7631a1bac0702a5cee40">Arg</a>(1));
<a name="l00888"></a>00888       <a class="code" href="classoperations__research_1_1IntVarSpec.html" title="Specification for integer variables.">IntVarSpec</a>* <span class="keyword">const</span> spec0 = IntSpec(var0);
<a name="l00889"></a>00889       <a class="code" href="classoperations__research_1_1IntVarSpec.html" title="Specification for integer variables.">IntVarSpec</a>* <span class="keyword">const</span> spec1 = IntSpec(var1);
<a name="l00890"></a>00890       <a class="code" href="classoperations__research_1_1ParserState.html#5a5475004786923ae85b7ec5b8084442">MergeIntDomain</a>(spec0, spec1);
<a name="l00891"></a>00891       <a class="code" href="classoperations__research_1_1ParserState.html#5a5475004786923ae85b7ec5b8084442">MergeIntDomain</a>(spec1, spec0);
<a name="l00892"></a>00892       <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#b3a612597c8bdd7ee4c60ad30d1e62f2">annotations</a>() == NULL &amp;&amp;
<a name="l00893"></a>00893           (ContainsKey(orphans_, <a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#3811d8604a3f7631a1bac0702a5cee40">Arg</a>(0))) ||
<a name="l00894"></a>00894            ContainsKey(orphans_, <a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#3811d8604a3f7631a1bac0702a5cee40">Arg</a>(1))))) {
<a name="l00895"></a>00895         <span class="keywordflow">if</span> (ContainsKey(orphans_, var0)) {
<a name="l00896"></a>00896           <a class="code" href="classoperations__research_1_1AstCall.html" title="Node representing a function call">AstCall</a>* <span class="keyword">const</span> call =
<a name="l00897"></a>00897               <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstCall.html" title="Node representing a function call">AstCall</a>(<span class="stringliteral">"defines_var"</span>, <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstIntVar.html" title="Integer variable node.">AstIntVar</a>(var0-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#ab61375d4213db96ca10dc84b83fc3fd" title="Cast this node to an integer variable node.">getIntVar</a>()));
<a name="l00898"></a>00898           spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#67cd6d9c5262aacae3ab336469127bee">AddAnnotation</a>(call);
<a name="l00899"></a>00899           VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  aliasing "</span> &lt;&lt; var0-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#6e981e3dac0a576beecf101e5d89a806" title="Output string representation.">DebugString</a>()
<a name="l00900"></a>00900                   &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; var1-&gt;DebugString();
<a name="l00901"></a>00901           orphans_.erase(var0);
<a name="l00902"></a>00902           targets_.insert(var0);
<a name="l00903"></a>00903           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00904"></a>00904         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ContainsKey(orphans_, var1)) {
<a name="l00905"></a>00905           AstCall* <span class="keyword">const</span> call =
<a name="l00906"></a>00906               <span class="keyword">new</span> AstCall(<span class="stringliteral">"defines_var"</span>, <span class="keyword">new</span> AstIntVar(var1-&gt;getIntVar()));
<a name="l00907"></a>00907           spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#67cd6d9c5262aacae3ab336469127bee">AddAnnotation</a>(call);
<a name="l00908"></a>00908           VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  aliasing "</span> &lt;&lt; var1-&gt;DebugString()
<a name="l00909"></a>00909                   &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; var0-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#6e981e3dac0a576beecf101e5d89a806" title="Output string representation.">DebugString</a>();
<a name="l00910"></a>00910           orphans_.erase(var1);
<a name="l00911"></a>00911           targets_.insert(var1);
<a name="l00912"></a>00912           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00913"></a>00913         }
<a name="l00914"></a>00914       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#b3a612597c8bdd7ee4c60ad30d1e62f2">annotations</a>() == NULL &amp;&amp;
<a name="l00915"></a>00915                  (!ContainsKey(targets_, <a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#3811d8604a3f7631a1bac0702a5cee40">Arg</a>(0))) ||
<a name="l00916"></a>00916                   !ContainsKey(targets_, <a class="code" href="classoperations__research_1_1ParserState.html#7b85dde1ba197e34e541038da4c1c06e">Copy</a>(spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#3811d8604a3f7631a1bac0702a5cee40">Arg</a>(1))))) {
<a name="l00917"></a>00917         <span class="keywordflow">if</span> (!ContainsKey(targets_, var0)) {
<a name="l00918"></a>00918           AstCall* <span class="keyword">const</span> call =
<a name="l00919"></a>00919               <span class="keyword">new</span> AstCall(<span class="stringliteral">"defines_var"</span>, <span class="keyword">new</span> AstIntVar(var0-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#ab61375d4213db96ca10dc84b83fc3fd" title="Cast this node to an integer variable node.">getIntVar</a>()));
<a name="l00920"></a>00920           spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#67cd6d9c5262aacae3ab336469127bee">AddAnnotation</a>(call);
<a name="l00921"></a>00921           VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  force aliasing "</span> &lt;&lt; var0-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#6e981e3dac0a576beecf101e5d89a806" title="Output string representation.">DebugString</a>()
<a name="l00922"></a>00922                   &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; var1-&gt;DebugString();
<a name="l00923"></a>00923           targets_.insert(var0);
<a name="l00924"></a>00924           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00925"></a>00925         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ContainsKey(targets_, var1)) {
<a name="l00926"></a>00926           AstCall* <span class="keyword">const</span> call =
<a name="l00927"></a>00927               <span class="keyword">new</span> AstCall(<span class="stringliteral">"defines_var"</span>, <span class="keyword">new</span> AstIntVar(var1-&gt;getIntVar()));
<a name="l00928"></a>00928           spec-&gt;<a class="code" href="classoperations__research_1_1CtSpec.html#67cd6d9c5262aacae3ab336469127bee">AddAnnotation</a>(call);
<a name="l00929"></a>00929           VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  force aliasing "</span> &lt;&lt; var1-&gt;DebugString()
<a name="l00930"></a>00930                   &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; var0-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#6e981e3dac0a576beecf101e5d89a806" title="Output string representation.">DebugString</a>();
<a name="l00931"></a>00931           targets_.insert(var1);
<a name="l00932"></a>00932           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00933"></a>00933         }
<a name="l00934"></a>00934       }
<a name="l00935"></a>00935     }
<a name="l00936"></a>00936   }
<a name="l00937"></a>00937   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00938"></a>00938 }
<a name="l00939"></a>00939 
<a name="l00940"></a>00940 <span class="keywordtype">bool</span> ParserState::PresolveOneConstraint(CtSpec* <span class="keyword">const</span> spec) {
<a name="l00941"></a>00941   <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; <span class="keywordtype">id</span> = spec-&gt;Id();
<a name="l00942"></a>00942   <span class="keyword">const</span> <span class="keywordtype">int</span> index = spec-&gt;Index();
<a name="l00943"></a>00943   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_le"</span>) {
<a name="l00944"></a>00944     <span class="keywordflow">if</span> (spec-&gt;Arg(0)-&gt;isIntVar() &amp;&amp; <a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;Arg(1))) {
<a name="l00945"></a>00945       IntVarSpec* <span class="keyword">const</span> var_spec = IntSpec(spec-&gt;Arg(0));
<a name="l00946"></a>00946       <span class="keyword">const</span> <span class="keywordtype">int</span> bound = <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;Arg(1));
<a name="l00947"></a>00947       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  merge "</span> &lt;&lt; var_spec-&gt;DebugString()
<a name="l00948"></a>00948               &lt;&lt; <span class="stringliteral">" with kint32min.."</span> &lt;&lt; bound;
<a name="l00949"></a>00949       <span class="keyword">const</span> <span class="keywordtype">bool</span> ok = var_spec-&gt;MergeBounds(kint32min, bound);
<a name="l00950"></a>00950       <span class="keywordflow">if</span> (ok) {
<a name="l00951"></a>00951         spec-&gt;Nullify();
<a name="l00952"></a>00952       }
<a name="l00953"></a>00953       <span class="keywordflow">return</span> ok;
<a name="l00954"></a>00954     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;Arg(0)) &amp;&amp; spec-&gt;Arg(1)-&gt;isIntVar()) {
<a name="l00955"></a>00955       IntVarSpec* <span class="keyword">const</span> var_spec = IntSpec(spec-&gt;Arg(1));
<a name="l00956"></a>00956       <span class="keyword">const</span> <span class="keywordtype">int</span> bound = <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;Arg(0));
<a name="l00957"></a>00957       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  merge "</span> &lt;&lt; var_spec-&gt;DebugString() &lt;&lt; <span class="stringliteral">" with "</span>
<a name="l00958"></a>00958               &lt;&lt; bound &lt;&lt; <span class="stringliteral">"..kint32max"</span>;
<a name="l00959"></a>00959       <span class="keyword">const</span> <span class="keywordtype">bool</span> ok = var_spec-&gt;MergeBounds(bound, kint32max);
<a name="l00960"></a>00960       <span class="keywordflow">if</span> (ok) {
<a name="l00961"></a>00961         spec-&gt;Nullify();
<a name="l00962"></a>00962       }
<a name="l00963"></a>00963       <span class="keywordflow">return</span> ok;
<a name="l00964"></a>00964     }
<a name="l00965"></a>00965   }
<a name="l00966"></a>00966   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_eq"</span>) {
<a name="l00967"></a>00967     <span class="keywordflow">if</span> (spec-&gt;Arg(0)-&gt;isIntVar() &amp;&amp; <a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;Arg(1))) {
<a name="l00968"></a>00968       IntVarSpec* <span class="keyword">const</span> var_spec = IntSpec(spec-&gt;Arg(0));
<a name="l00969"></a>00969       <span class="keyword">const</span> <span class="keywordtype">int</span> bound = <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;Arg(1));
<a name="l00970"></a>00970       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  assign "</span> &lt;&lt; var_spec-&gt;DebugString()
<a name="l00971"></a>00971               &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; bound;
<a name="l00972"></a>00972       <span class="keyword">const</span> <span class="keywordtype">bool</span> ok = var_spec-&gt;MergeBounds(bound, bound);
<a name="l00973"></a>00973       <span class="keywordflow">if</span> (ok) {
<a name="l00974"></a>00974         spec-&gt;Nullify();
<a name="l00975"></a>00975       }
<a name="l00976"></a>00976       <span class="keywordflow">return</span> ok;
<a name="l00977"></a>00977     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;Arg(0)) &amp;&amp; spec-&gt;Arg(1)-&gt;isIntVar()) {
<a name="l00978"></a>00978       IntVarSpec* <span class="keyword">const</span> var_spec = IntSpec(spec-&gt;Arg(1));
<a name="l00979"></a>00979       <span class="keyword">const</span> <span class="keywordtype">int</span> bound = <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;Arg(0));
<a name="l00980"></a>00980       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  assign "</span> &lt;&lt;  var_spec-&gt;DebugString()
<a name="l00981"></a>00981               &lt;&lt; <span class="stringliteral">" to "</span> &lt;&lt; bound;
<a name="l00982"></a>00982       <span class="keyword">const</span> <span class="keywordtype">bool</span> ok = var_spec-&gt;MergeBounds(bound, bound);
<a name="l00983"></a>00983       <span class="keywordflow">if</span> (ok) {
<a name="l00984"></a>00984         spec-&gt;Nullify();
<a name="l00985"></a>00985       }
<a name="l00986"></a>00986       <span class="keywordflow">return</span> ok;
<a name="l00987"></a>00987     }
<a name="l00988"></a>00988   }
<a name="l00989"></a>00989   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_ne"</span>) {
<a name="l00990"></a>00990     <span class="keywordflow">if</span> (spec-&gt;Arg(0)-&gt;isIntVar() &amp;&amp; <a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;Arg(1))) {
<a name="l00991"></a>00991       IntVarSpec* <span class="keyword">const</span> var_spec = IntSpec(spec-&gt;Arg(0));
<a name="l00992"></a>00992       <span class="keyword">const</span> <span class="keywordtype">int</span> bound = <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;Arg(1));
<a name="l00993"></a>00993       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  remove value "</span> &lt;&lt; bound &lt;&lt; <span class="stringliteral">" from "</span>
<a name="l00994"></a>00994               &lt;&lt; var_spec-&gt;DebugString();
<a name="l00995"></a>00995       <span class="keyword">const</span> <span class="keywordtype">bool</span> ok = var_spec-&gt;RemoveValue(bound);
<a name="l00996"></a>00996       <span class="keywordflow">if</span> (ok) {
<a name="l00997"></a>00997         spec-&gt;Nullify();
<a name="l00998"></a>00998       }
<a name="l00999"></a>00999       <span class="keywordflow">return</span> ok;
<a name="l01000"></a>01000     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;Arg(0)) &amp;&amp; spec-&gt;Arg(1)-&gt;isIntVar()) {
<a name="l01001"></a>01001       IntVarSpec* <span class="keyword">const</span> var_spec = IntSpec(spec-&gt;Arg(1));
<a name="l01002"></a>01002       <span class="keyword">const</span> <span class="keywordtype">int</span> bound = <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;Arg(0));
<a name="l01003"></a>01003       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  remove value "</span> &lt;&lt; bound &lt;&lt; <span class="stringliteral">" from "</span>
<a name="l01004"></a>01004               &lt;&lt; var_spec-&gt;DebugString();
<a name="l01005"></a>01005       <span class="keyword">const</span> <span class="keywordtype">bool</span> ok = var_spec-&gt;RemoveValue(bound);
<a name="l01006"></a>01006       <span class="keywordflow">if</span> (ok) {
<a name="l01007"></a>01007         spec-&gt;Nullify();
<a name="l01008"></a>01008       }
<a name="l01009"></a>01009       <span class="keywordflow">return</span> ok;
<a name="l01010"></a>01010     }
<a name="l01011"></a>01011   }
<a name="l01012"></a>01012   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"set_in"</span>) {
<a name="l01013"></a>01013     <span class="keywordflow">if</span> (spec-&gt;Arg(0)-&gt;isIntVar() &amp;&amp; spec-&gt;Arg(1)-&gt;isSet()) {
<a name="l01014"></a>01014       IntVarSpec* <span class="keyword">const</span> var_spec = IntSpec(spec-&gt;Arg(0));
<a name="l01015"></a>01015       AstSetLit* <span class="keyword">const</span> domain = spec-&gt;Arg(1)-&gt;getSet();
<a name="l01016"></a>01016       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  merge "</span> &lt;&lt; var_spec-&gt;DebugString() &lt;&lt; <span class="stringliteral">" with "</span>
<a name="l01017"></a>01017               &lt;&lt; domain-&gt;DebugString();
<a name="l01018"></a>01018       <span class="keywordtype">bool</span> ok = <span class="keyword">false</span>;
<a name="l01019"></a>01019       <span class="keywordflow">if</span> (domain-&gt;interval) {
<a name="l01020"></a>01020         ok = var_spec-&gt;MergeBounds(domain-&gt;imin, domain-&gt;imax);
<a name="l01021"></a>01021       } <span class="keywordflow">else</span> {
<a name="l01022"></a>01022         ok = var_spec-&gt;MergeDomain(domain-&gt;s);
<a name="l01023"></a>01023       }
<a name="l01024"></a>01024       <span class="keywordflow">if</span> (ok) {
<a name="l01025"></a>01025         spec-&gt;Nullify();
<a name="l01026"></a>01026       }
<a name="l01027"></a>01027       <span class="keywordflow">return</span> ok;
<a name="l01028"></a>01028     }
<a name="l01029"></a>01029   }
<a name="l01030"></a>01030   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"array_bool_and"</span> &amp;&amp;
<a name="l01031"></a>01031       <a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;Arg(1)) &amp;&amp;
<a name="l01032"></a>01032       <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;Arg(1)) == 1) {
<a name="l01033"></a>01033     VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  forcing array_bool_and to 1 on "</span>
<a name="l01034"></a>01034             &lt;&lt; spec-&gt;DebugString();
<a name="l01035"></a>01035     AstArray* <span class="keyword">const</span> array_variables = spec-&gt;Arg(0)-&gt;getArray();
<a name="l01036"></a>01036     <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_variables-&gt;a.size();
<a name="l01037"></a>01037     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01038"></a>01038       <span class="keywordflow">if</span> (array_variables-&gt;a[i]-&gt;isBoolVar()) {
<a name="l01039"></a>01039         <span class="keyword">const</span> <span class="keywordtype">int</span> boolvar = array_variables-&gt;a[i]-&gt;getBoolVar();
<a name="l01040"></a>01040         <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>[boolvar]-&gt;Assign(<span class="keyword">true</span>);
<a name="l01041"></a>01041       }
<a name="l01042"></a>01042     }
<a name="l01043"></a>01043     spec-&gt;Nullify();
<a name="l01044"></a>01044     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01045"></a>01045   }
<a name="l01046"></a>01046   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"array_bool_or"</span> &amp;&amp;
<a name="l01047"></a>01047       <a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;Arg(1)) &amp;&amp;
<a name="l01048"></a>01048       <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;Arg(1)) == 0) {
<a name="l01049"></a>01049     VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  forcing array_bool_or to 0 on "</span>
<a name="l01050"></a>01050             &lt;&lt; spec-&gt;DebugString();
<a name="l01051"></a>01051     AstArray* <span class="keyword">const</span> array_variables = spec-&gt;Arg(0)-&gt;getArray();
<a name="l01052"></a>01052     <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_variables-&gt;a.size();
<a name="l01053"></a>01053     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01054"></a>01054       <span class="keywordflow">if</span> (array_variables-&gt;a[i]-&gt;isBoolVar()) {
<a name="l01055"></a>01055         <span class="keyword">const</span> <span class="keywordtype">int</span> boolvar = array_variables-&gt;a[i]-&gt;getBoolVar();
<a name="l01056"></a>01056         <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>[boolvar]-&gt;Assign(<span class="keyword">false</span>);
<a name="l01057"></a>01057       }
<a name="l01058"></a>01058     }
<a name="l01059"></a>01059     spec-&gt;Nullify();
<a name="l01060"></a>01060     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01061"></a>01061   }
<a name="l01062"></a>01062   <span class="keywordflow">if</span> (<span class="keywordtype">id</span>.find(<span class="stringliteral">"_reif"</span>) != string::npos &amp;&amp;
<a name="l01063"></a>01063       <a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;LastArg()) &amp;&amp;
<a name="l01064"></a>01064       <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;LastArg()) == 1) {
<a name="l01065"></a>01065     VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  unreify "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01066"></a>01066     spec-&gt;Unreify();
<a name="l01067"></a>01067     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01068"></a>01068   }
<a name="l01069"></a>01069   <span class="keywordflow">if</span> (<span class="keywordtype">id</span>.find(<span class="stringliteral">"_reif"</span>) != string::npos &amp;&amp;
<a name="l01070"></a>01070       <a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;LastArg()) &amp;&amp;
<a name="l01071"></a>01071       <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;LastArg()) == 0) {
<a name="l01072"></a>01072     VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  unreify and inverse "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01073"></a>01073     spec-&gt;Unreify();
<a name="l01074"></a>01074     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_eq"</span>) {
<a name="l01075"></a>01075       spec-&gt;SetId(<span class="stringliteral">"int_ne"</span>);
<a name="l01076"></a>01076     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_ne"</span>) {
<a name="l01077"></a>01077       spec-&gt;SetId(<span class="stringliteral">"int_eq"</span>);
<a name="l01078"></a>01078     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_ge"</span>) {
<a name="l01079"></a>01079       spec-&gt;SetId(<span class="stringliteral">"int_lt"</span>);
<a name="l01080"></a>01080     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_gt"</span>) {
<a name="l01081"></a>01081       spec-&gt;SetId(<span class="stringliteral">"int_le"</span>);
<a name="l01082"></a>01082     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_le"</span>) {
<a name="l01083"></a>01083       spec-&gt;SetId(<span class="stringliteral">"int_gt"</span>);
<a name="l01084"></a>01084     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lt"</span>) {
<a name="l01085"></a>01085       spec-&gt;SetId(<span class="stringliteral">"int_ge"</span>);
<a name="l01086"></a>01086     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_eq"</span>) {
<a name="l01087"></a>01087       spec-&gt;SetId(<span class="stringliteral">"int_lin_ne"</span>);
<a name="l01088"></a>01088     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_ne"</span>) {
<a name="l01089"></a>01089       spec-&gt;SetId(<span class="stringliteral">"int_lin_eq"</span>);
<a name="l01090"></a>01090     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_ge"</span>) {
<a name="l01091"></a>01091       spec-&gt;SetId(<span class="stringliteral">"int_lin_lt"</span>);
<a name="l01092"></a>01092     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_gt"</span>) {
<a name="l01093"></a>01093       spec-&gt;SetId(<span class="stringliteral">"int_lin_le"</span>);
<a name="l01094"></a>01094     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_le"</span>) {
<a name="l01095"></a>01095       spec-&gt;SetId(<span class="stringliteral">"int_lin_gt"</span>);
<a name="l01096"></a>01096     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_lt"</span>) {
<a name="l01097"></a>01097       spec-&gt;SetId(<span class="stringliteral">"int_lin_ge"</span>);
<a name="l01098"></a>01098     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_eq"</span>) {
<a name="l01099"></a>01099       spec-&gt;SetId(<span class="stringliteral">"bool_ne"</span>);
<a name="l01100"></a>01100     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_ne"</span>) {
<a name="l01101"></a>01101       spec-&gt;SetId(<span class="stringliteral">"bool_eq"</span>);
<a name="l01102"></a>01102     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_ge"</span>) {
<a name="l01103"></a>01103       spec-&gt;SetId(<span class="stringliteral">"bool_lt"</span>);
<a name="l01104"></a>01104     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_gt"</span>) {
<a name="l01105"></a>01105       spec-&gt;SetId(<span class="stringliteral">"bool_le"</span>);
<a name="l01106"></a>01106     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_le"</span>) {
<a name="l01107"></a>01107       spec-&gt;SetId(<span class="stringliteral">"bool_gt"</span>);
<a name="l01108"></a>01108     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_lt"</span>) {
<a name="l01109"></a>01109       spec-&gt;SetId(<span class="stringliteral">"bool_ge"</span>);
<a name="l01110"></a>01110     }
<a name="l01111"></a>01111     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01112"></a>01112   }
<a name="l01113"></a>01113   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"all_different_int"</span> &amp;&amp; !ContainsKey(stored_constraints_, spec)) {
<a name="l01114"></a>01114     AstArray* <span class="keyword">const</span> array_variables = spec-&gt;Arg(0)-&gt;getArray();
<a name="l01115"></a>01115     <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_variables-&gt;a.size();
<a name="l01116"></a>01116     std::vector&lt;int&gt; variables(size);
<a name="l01117"></a>01117     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01118"></a>01118       <span class="keywordflow">if</span> (array_variables-&gt;a[i]-&gt;isIntVar()) {
<a name="l01119"></a>01119         <span class="keyword">const</span> <span class="keywordtype">int</span> var = array_variables-&gt;a[i]-&gt;getIntVar();
<a name="l01120"></a>01120         variables[i] = var;
<a name="l01121"></a>01121       } <span class="keywordflow">else</span> {
<a name="l01122"></a>01122         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01123"></a>01123       }
<a name="l01124"></a>01124     }
<a name="l01125"></a>01125     VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  store all diff info "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01126"></a>01126     std::sort(variables.begin(), variables.end());
<a name="l01127"></a>01127     stored_constraints_.insert(spec);
<a name="l01128"></a>01128     all_differents_.push_back(variables);
<a name="l01129"></a>01129     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01130"></a>01130   }
<a name="l01131"></a>01131   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"array_var_int_element"</span> &amp;&amp;
<a name="l01132"></a>01132       <a class="code" href="classoperations__research_1_1ParserState.html#13f37fa3e58ef2e7f2ec265c6cbecee0">IsBound</a>(spec-&gt;Arg(2)) &amp;&amp;
<a name="l01133"></a>01133       <a class="code" href="classoperations__research_1_1ParserState.html#12acd48dbdaed090b19b8d54025f38fc">IsAllDifferent</a>(spec-&gt;Arg(1))) {
<a name="l01134"></a>01134     VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  reinforce "</span> &lt;&lt; spec-&gt;DebugString()
<a name="l01135"></a>01135             &lt;&lt; <span class="stringliteral">" to array_var_int_position"</span>;
<a name="l01136"></a>01136     spec-&gt;SetId(<span class="stringliteral">"array_var_int_position"</span>);
<a name="l01137"></a>01137     <span class="keyword">const</span> <span class="keywordtype">int</span> bound = <a class="code" href="classoperations__research_1_1ParserState.html#88155a8495a2ef56157bc4716101a67e">GetBound</a>(spec-&gt;Arg(2));
<a name="l01138"></a>01138     spec-&gt;ReplaceArg(2, <span class="keyword">new</span> AstIntLit(bound));
<a name="l01139"></a>01139     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01140"></a>01140   }
<a name="l01141"></a>01141   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_abs"</span> &amp;&amp;
<a name="l01142"></a>01142       !ContainsKey(stored_constraints_, spec) &amp;&amp;
<a name="l01143"></a>01143       spec-&gt;Arg(0)-&gt;isIntVar() &amp;&amp;
<a name="l01144"></a>01144       spec-&gt;Arg(1)-&gt;isIntVar()) {
<a name="l01145"></a>01145     abs_map_[spec-&gt;Arg(1)-&gt;getIntVar()] = spec-&gt;Arg(0)-&gt;getIntVar();
<a name="l01146"></a>01146     stored_constraints_.insert(spec);
<a name="l01147"></a>01147     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01148"></a>01148   }
<a name="l01149"></a>01149   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_eq_reif"</span>) {
<a name="l01150"></a>01150     <span class="keywordflow">if</span> (spec-&gt;Arg(0)-&gt;isIntVar() &amp;&amp;
<a name="l01151"></a>01151         ContainsKey(abs_map_, spec-&gt;Arg(0)-&gt;getIntVar()) &amp;&amp;
<a name="l01152"></a>01152         spec-&gt;Arg(1)-&gt;isInt() &amp;&amp;
<a name="l01153"></a>01153         spec-&gt;Arg(1)-&gt;getInt() == 0) {
<a name="l01154"></a>01154       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  remove abs() in "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01155"></a>01155       <span class="keyword">dynamic_cast&lt;</span>AstIntVar*<span class="keyword">&gt;</span>(spec-&gt;Arg(0))-&gt;i =
<a name="l01156"></a>01156           abs_map_[spec-&gt;Arg(0)-&gt;getIntVar()];
<a name="l01157"></a>01157     }
<a name="l01158"></a>01158   }
<a name="l01159"></a>01159   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_ne_reif"</span>) {
<a name="l01160"></a>01160     <span class="keywordflow">if</span> (spec-&gt;Arg(0)-&gt;isIntVar() &amp;&amp;
<a name="l01161"></a>01161         ContainsKey(abs_map_, spec-&gt;Arg(0)-&gt;getIntVar()) &amp;&amp;
<a name="l01162"></a>01162         spec-&gt;Arg(1)-&gt;isInt() &amp;&amp;
<a name="l01163"></a>01163         spec-&gt;Arg(1)-&gt;getInt() == 0) {
<a name="l01164"></a>01164       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  remove abs() in "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01165"></a>01165       <span class="keyword">dynamic_cast&lt;</span>AstIntVar*<span class="keyword">&gt;</span>(spec-&gt;Arg(0))-&gt;i =
<a name="l01166"></a>01166           abs_map_[spec-&gt;Arg(0)-&gt;getIntVar()];
<a name="l01167"></a>01167     }
<a name="l01168"></a>01168   }
<a name="l01169"></a>01169   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_ne"</span>) {
<a name="l01170"></a>01170     <span class="keywordflow">if</span> (spec-&gt;Arg(0)-&gt;isIntVar() &amp;&amp;
<a name="l01171"></a>01171         ContainsKey(abs_map_, spec-&gt;Arg(0)-&gt;getIntVar()) &amp;&amp;
<a name="l01172"></a>01172         spec-&gt;Arg(1)-&gt;isInt() &amp;&amp;
<a name="l01173"></a>01173         spec-&gt;Arg(1)-&gt;getInt() == 0) {
<a name="l01174"></a>01174       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  remove abs() in "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01175"></a>01175       <span class="keyword">dynamic_cast&lt;</span>AstIntVar*<span class="keyword">&gt;</span>(spec-&gt;Arg(0))-&gt;i =
<a name="l01176"></a>01176           abs_map_[spec-&gt;Arg(0)-&gt;getIntVar()];
<a name="l01177"></a>01177     }
<a name="l01178"></a>01178   }
<a name="l01179"></a>01179   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_le"</span>) {
<a name="l01180"></a>01180     AstArray* <span class="keyword">const</span> array_coefficients = spec-&gt;Arg(0)-&gt;getArray();
<a name="l01181"></a>01181     AstNode* <span class="keyword">const</span> node_rhs = spec-&gt;Arg(2);
<a name="l01182"></a>01182     <span class="keyword">const</span> int64 rhs = node_rhs-&gt;getInt();
<a name="l01183"></a>01183     <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_coefficients-&gt;a.size();
<a name="l01184"></a>01184     <span class="keywordtype">bool</span> one_positive = <span class="keyword">false</span>;
<a name="l01185"></a>01185     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01186"></a>01186       <span class="keywordflow">if</span> (array_coefficients-&gt;a[i]-&gt;getInt() &gt; 0) {
<a name="l01187"></a>01187         one_positive = <span class="keyword">true</span>;
<a name="l01188"></a>01188         <span class="keywordflow">break</span>;
<a name="l01189"></a>01189       }
<a name="l01190"></a>01190     }
<a name="l01191"></a>01191     <span class="keywordflow">if</span> (!one_positive) {
<a name="l01192"></a>01192       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  transform all negative int_lin_le into "</span>
<a name="l01193"></a>01193               &lt;&lt; <span class="stringliteral">"int_lin_ge in "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01194"></a>01194 
<a name="l01195"></a>01195       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01196"></a>01196         array_coefficients-&gt;a[i]-&gt;setInt(-array_coefficients-&gt;a[i]-&gt;getInt());
<a name="l01197"></a>01197       }
<a name="l01198"></a>01198       spec-&gt;Arg(2)-&gt;setInt(-spec-&gt;Arg(2)-&gt;getInt());
<a name="l01199"></a>01199       spec-&gt;SetId(<span class="stringliteral">"int_lin_ge"</span>);
<a name="l01200"></a>01200       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01201"></a>01201     }
<a name="l01202"></a>01202   }
<a name="l01203"></a>01203   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_le_reif"</span>) {
<a name="l01204"></a>01204     AstArray* <span class="keyword">const</span> array_coefficients = spec-&gt;Arg(0)-&gt;getArray();
<a name="l01205"></a>01205     AstNode* <span class="keyword">const</span> node_rhs = spec-&gt;Arg(2);
<a name="l01206"></a>01206     <span class="keyword">const</span> int64 rhs = node_rhs-&gt;getInt();
<a name="l01207"></a>01207     <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_coefficients-&gt;a.size();
<a name="l01208"></a>01208     <span class="keywordtype">bool</span> one_positive = <span class="keyword">false</span>;
<a name="l01209"></a>01209     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01210"></a>01210       <span class="keywordflow">if</span> (array_coefficients-&gt;a[i]-&gt;getInt() &gt; 0) {
<a name="l01211"></a>01211         one_positive = <span class="keyword">true</span>;
<a name="l01212"></a>01212         <span class="keywordflow">break</span>;
<a name="l01213"></a>01213       }
<a name="l01214"></a>01214     }
<a name="l01215"></a>01215     <span class="keywordflow">if</span> (!one_positive) {
<a name="l01216"></a>01216       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  transform all negative int_lin_le_reif into "</span>
<a name="l01217"></a>01217               &lt;&lt; <span class="stringliteral">"int_lin_ge_reif in "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01218"></a>01218       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01219"></a>01219         array_coefficients-&gt;a[i]-&gt;setInt(-array_coefficients-&gt;a[i]-&gt;getInt());
<a name="l01220"></a>01220       }
<a name="l01221"></a>01221       spec-&gt;Arg(2)-&gt;setInt(-spec-&gt;Arg(2)-&gt;getInt());
<a name="l01222"></a>01222       spec-&gt;SetId(<span class="stringliteral">"int_lin_ge_reif"</span>);
<a name="l01223"></a>01223       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01224"></a>01224     }
<a name="l01225"></a>01225   }
<a name="l01226"></a>01226   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_lt"</span>) {
<a name="l01227"></a>01227     AstArray* <span class="keyword">const</span> array_coefficients = spec-&gt;Arg(0)-&gt;getArray();
<a name="l01228"></a>01228     AstNode* <span class="keyword">const</span> node_rhs = spec-&gt;Arg(2);
<a name="l01229"></a>01229     <span class="keyword">const</span> int64 rhs = node_rhs-&gt;getInt();
<a name="l01230"></a>01230     <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_coefficients-&gt;a.size();
<a name="l01231"></a>01231     <span class="keywordtype">bool</span> one_positive = <span class="keyword">false</span>;
<a name="l01232"></a>01232     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01233"></a>01233       <span class="keywordflow">if</span> (array_coefficients-&gt;a[i]-&gt;getInt() &gt; 0) {
<a name="l01234"></a>01234         one_positive = <span class="keyword">true</span>;
<a name="l01235"></a>01235         <span class="keywordflow">break</span>;
<a name="l01236"></a>01236       }
<a name="l01237"></a>01237     }
<a name="l01238"></a>01238     <span class="keywordflow">if</span> (!one_positive) {
<a name="l01239"></a>01239       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  transform all negative int_lin_lt into "</span>
<a name="l01240"></a>01240               &lt;&lt; <span class="stringliteral">"int_lin_gt in "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01241"></a>01241 
<a name="l01242"></a>01242       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01243"></a>01243         array_coefficients-&gt;a[i]-&gt;setInt(-array_coefficients-&gt;a[i]-&gt;getInt());
<a name="l01244"></a>01244       }
<a name="l01245"></a>01245       spec-&gt;Arg(2)-&gt;setInt(-spec-&gt;Arg(2)-&gt;getInt());
<a name="l01246"></a>01246       spec-&gt;SetId(<span class="stringliteral">"int_lin_gt"</span>);
<a name="l01247"></a>01247       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01248"></a>01248     }
<a name="l01249"></a>01249   }
<a name="l01250"></a>01250   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_lt_reif"</span>) {
<a name="l01251"></a>01251     AstArray* <span class="keyword">const</span> array_coefficients = spec-&gt;Arg(0)-&gt;getArray();
<a name="l01252"></a>01252     AstNode* <span class="keyword">const</span> node_rhs = spec-&gt;Arg(2);
<a name="l01253"></a>01253     <span class="keyword">const</span> int64 rhs = node_rhs-&gt;getInt();
<a name="l01254"></a>01254     <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_coefficients-&gt;a.size();
<a name="l01255"></a>01255     <span class="keywordtype">bool</span> one_positive = <span class="keyword">false</span>;
<a name="l01256"></a>01256     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01257"></a>01257       <span class="keywordflow">if</span> (array_coefficients-&gt;a[i]-&gt;getInt() &gt; 0) {
<a name="l01258"></a>01258         one_positive = <span class="keyword">true</span>;
<a name="l01259"></a>01259         <span class="keywordflow">break</span>;
<a name="l01260"></a>01260       }
<a name="l01261"></a>01261     }
<a name="l01262"></a>01262     <span class="keywordflow">if</span> (!one_positive) {
<a name="l01263"></a>01263       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  transform all negative int_lin_lt_reif into "</span>
<a name="l01264"></a>01264               &lt;&lt; <span class="stringliteral">"int_lin_gt_reif in "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01265"></a>01265       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01266"></a>01266         array_coefficients-&gt;a[i]-&gt;setInt(-array_coefficients-&gt;a[i]-&gt;getInt());
<a name="l01267"></a>01267       }
<a name="l01268"></a>01268       spec-&gt;Arg(2)-&gt;setInt(-spec-&gt;Arg(2)-&gt;getInt());
<a name="l01269"></a>01269       spec-&gt;SetId(<span class="stringliteral">"int_lin_gt_reif"</span>);
<a name="l01270"></a>01270       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01271"></a>01271     }
<a name="l01272"></a>01272   }
<a name="l01273"></a>01273   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_eq"</span>) {
<a name="l01274"></a>01274     AstArray* <span class="keyword">const</span> array_coefficients = spec-&gt;Arg(0)-&gt;getArray();
<a name="l01275"></a>01275     AstNode* <span class="keyword">const</span> node_rhs = spec-&gt;Arg(2);
<a name="l01276"></a>01276     <span class="keyword">const</span> int64 rhs = node_rhs-&gt;getInt();
<a name="l01277"></a>01277     <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_coefficients-&gt;a.size();
<a name="l01278"></a>01278     <span class="keywordtype">bool</span> one_positive = <span class="keyword">false</span>;
<a name="l01279"></a>01279     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01280"></a>01280       <span class="keywordflow">if</span> (array_coefficients-&gt;a[i]-&gt;getInt() &gt; 0) {
<a name="l01281"></a>01281         one_positive = <span class="keyword">true</span>;
<a name="l01282"></a>01282         <span class="keywordflow">break</span>;
<a name="l01283"></a>01283       }
<a name="l01284"></a>01284     }
<a name="l01285"></a>01285     <span class="keywordflow">if</span> (!one_positive &amp;&amp; !<a class="code" href="namespaceoperations__research.html#310a33e66757f57c39f28f08009ab8a9">HasDefineAnnotation</a>(spec-&gt;annotations())) {
<a name="l01286"></a>01286       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  transform all negative int_lin_eq into "</span>
<a name="l01287"></a>01287               &lt;&lt; <span class="stringliteral">"int_lin_eq in "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01288"></a>01288 
<a name="l01289"></a>01289       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01290"></a>01290         array_coefficients-&gt;a[i]-&gt;setInt(-array_coefficients-&gt;a[i]-&gt;getInt());
<a name="l01291"></a>01291       }
<a name="l01292"></a>01292       spec-&gt;Arg(2)-&gt;setInt(-spec-&gt;Arg(2)-&gt;getInt());
<a name="l01293"></a>01293       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01294"></a>01294     }
<a name="l01295"></a>01295   }
<a name="l01296"></a>01296   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"int_lin_eq_reif"</span>) {
<a name="l01297"></a>01297     AstArray* <span class="keyword">const</span> array_coefficients = spec-&gt;Arg(0)-&gt;getArray();
<a name="l01298"></a>01298     AstNode* <span class="keyword">const</span> node_rhs = spec-&gt;Arg(2);
<a name="l01299"></a>01299     <span class="keyword">const</span> int64 rhs = node_rhs-&gt;getInt();
<a name="l01300"></a>01300     <span class="keyword">const</span> <span class="keywordtype">int</span> size = array_coefficients-&gt;a.size();
<a name="l01301"></a>01301     <span class="keywordtype">bool</span> one_positive = <span class="keyword">false</span>;
<a name="l01302"></a>01302     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01303"></a>01303       <span class="keywordflow">if</span> (array_coefficients-&gt;a[i]-&gt;getInt() &gt; 0) {
<a name="l01304"></a>01304         one_positive = <span class="keyword">true</span>;
<a name="l01305"></a>01305         <span class="keywordflow">break</span>;
<a name="l01306"></a>01306       }
<a name="l01307"></a>01307     }
<a name="l01308"></a>01308     <span class="keywordflow">if</span> (!one_positive) {
<a name="l01309"></a>01309       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  transform all negative int_lin_eq_reif into "</span>
<a name="l01310"></a>01310               &lt;&lt; <span class="stringliteral">"int_lin_eq_reif in "</span> &lt;&lt; spec-&gt;DebugString();
<a name="l01311"></a>01311       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; size; ++i) {
<a name="l01312"></a>01312         array_coefficients-&gt;a[i]-&gt;setInt(-array_coefficients-&gt;a[i]-&gt;getInt());
<a name="l01313"></a>01313       }
<a name="l01314"></a>01314       spec-&gt;Arg(2)-&gt;setInt(-spec-&gt;Arg(2)-&gt;getInt());
<a name="l01315"></a>01315       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01316"></a>01316     }
<a name="l01317"></a>01317   }
<a name="l01318"></a>01318   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_eq_reif"</span>) {
<a name="l01319"></a>01319     <span class="keywordflow">if</span> (spec-&gt;Arg(0)-&gt;isBoolVar() &amp;&amp; spec-&gt;Arg(1)-&gt;isBool()) {
<a name="l01320"></a>01320       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  simplify bool_eq_reif in "</span>
<a name="l01321"></a>01321               &lt;&lt; spec-&gt;DebugString();
<a name="l01322"></a>01322       <span class="keywordflow">if</span> (spec-&gt;Arg(1)-&gt;getBool()) {  <span class="comment">// == 1</span>
<a name="l01323"></a>01323         spec-&gt;RemoveArg(1);
<a name="l01324"></a>01324         spec-&gt;SetId(<span class="stringliteral">"bool_eq"</span>);
<a name="l01325"></a>01325       } <span class="keywordflow">else</span> {
<a name="l01326"></a>01326         spec-&gt;RemoveArg(1);
<a name="l01327"></a>01327         spec-&gt;SetId(<span class="stringliteral">"bool_not"</span>);
<a name="l01328"></a>01328       }
<a name="l01329"></a>01329     }
<a name="l01330"></a>01330   }
<a name="l01331"></a>01331   <span class="keywordflow">if</span> (<span class="keywordtype">id</span> == <span class="stringliteral">"bool_ne_reif"</span>) {
<a name="l01332"></a>01332     <span class="keywordflow">if</span> (spec-&gt;Arg(0)-&gt;isBoolVar() &amp;&amp; spec-&gt;Arg(1)-&gt;isBool()) {
<a name="l01333"></a>01333       VLOG(1) &lt;&lt; <span class="stringliteral">"  - presolve:  simplify bool_ne_reif in "</span>
<a name="l01334"></a>01334               &lt;&lt; spec-&gt;DebugString();
<a name="l01335"></a>01335       <span class="keywordflow">if</span> (spec-&gt;Arg(1)-&gt;getBool()) {  <span class="comment">// == 1</span>
<a name="l01336"></a>01336         spec-&gt;RemoveArg(1);
<a name="l01337"></a>01337         spec-&gt;SetId(<span class="stringliteral">"bool_not"</span>);
<a name="l01338"></a>01338       } <span class="keywordflow">else</span> {
<a name="l01339"></a>01339         spec-&gt;RemoveArg(1);
<a name="l01340"></a>01340         spec-&gt;SetId(<span class="stringliteral">"bool_eq"</span>);
<a name="l01341"></a>01341       }
<a name="l01342"></a>01342     }
<a name="l01343"></a>01343   }
<a name="l01344"></a>01344   <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01345"></a>01345 }
<a name="l01346"></a>01346 
<a name="l01347"></a>01347 <span class="keywordtype">void</span> ParserState::ReplaceAliases(CtSpec* <span class="keyword">const</span> spec) {
<a name="l01348"></a>01348   <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; spec-&gt;NumArgs(); ++i) {
<a name="l01349"></a>01349     AstNode* <span class="keyword">const</span> arg = spec-&gt;Arg(i);
<a name="l01350"></a>01350     <span class="keywordflow">if</span> (arg-&gt;isIntVar()) {
<a name="l01351"></a>01351       <span class="keyword">const</span> <span class="keywordtype">int</span> var_index = arg-&gt;getIntVar();
<a name="l01352"></a>01352       <span class="keywordflow">if</span> (ContainsKey(int_aliases_, var_index)) {
<a name="l01353"></a>01353         <span class="keyword">dynamic_cast&lt;</span>AstIntVar*<span class="keyword">&gt;</span>(arg)-&gt;i = int_aliases_[var_index];
<a name="l01354"></a>01354       }
<a name="l01355"></a>01355     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arg-&gt;isArray()) {
<a name="l01356"></a>01356       AstArray* <span class="keyword">const</span> array = arg-&gt;getArray();
<a name="l01357"></a>01357       <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; array-&gt;a.size(); ++i) {
<a name="l01358"></a>01358         AstNode* <span class="keyword">const</span> node = array-&gt;a[i];
<a name="l01359"></a>01359         <span class="keywordflow">if</span> (node-&gt;isIntVar() &amp;&amp; ContainsKey(int_aliases_, node-&gt;getIntVar())) {
<a name="l01360"></a>01360           <span class="keyword">dynamic_cast&lt;</span>AstIntVar*<span class="keyword">&gt;</span>(node)-&gt;i = int_aliases_[node-&gt;getIntVar()];
<a name="l01361"></a>01361         }
<a name="l01362"></a>01362       }
<a name="l01363"></a>01363     }
<a name="l01364"></a>01364   }
<a name="l01365"></a>01365 }
<a name="l01366"></a>01366 
<a name="l01367"></a>01367 <span class="keywordtype">void</span> ParserState::Strongify(<span class="keywordtype">int</span> constraint_index) {
<a name="l01368"></a>01368 
<a name="l01369"></a>01369 }
<a name="l01370"></a>01370 
<a name="l01371"></a><a class="code" href="classoperations__research_1_1ParserState.html#d606cb56c6d6819b0ada29a296991490">01371</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1ParserState.html#d606cb56c6d6819b0ada29a296991490">ParserState::AddConstraint</a>(<span class="keyword">const</span> std::string&amp; <span class="keywordtype">id</span>,
<a name="l01372"></a>01372                                 <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>* <span class="keyword">const</span> args,
<a name="l01373"></a>01373                                 <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <span class="keyword">const</span> annotations) {
<a name="l01374"></a>01374   <a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.push_back(
<a name="l01375"></a>01375       <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1CtSpec.html">CtSpec</a>(<a class="code" href="classoperations__research_1_1ParserState.html#022dd15d5e64741c812aca03cda8a82f">constraints_</a>.size(), id, args, annotations));
<a name="l01376"></a>01376 }
<a name="l01377"></a>01377 
<a name="l01378"></a><a class="code" href="classoperations__research_1_1ParserState.html#20e89cbca5413f986d9399b777e013d4">01378</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1ParserState.html#20e89cbca5413f986d9399b777e013d4">ParserState::InitModel</a>() {
<a name="l01379"></a>01379   <span class="keywordflow">if</span> (!<a class="code" href="classoperations__research_1_1ParserState.html#162dbbfaa104af4a338457f84fcaeb84">hadError</a>) {
<a name="l01380"></a>01380     model_-&gt;<a class="code" href="classoperations__research_1_1FlatZincModel.html#0afdfb893a06dc26351e7c6178b9170a" title="Initialize space with given number of variables.">Init</a>(<a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>.size(),
<a name="l01381"></a>01381                  <a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>.size(),
<a name="l01382"></a>01382                  <a class="code" href="classoperations__research_1_1ParserState.html#b25b9ef5be1cf155545ea830fd7f2387">set_variables_</a>.size());
<a name="l01383"></a>01383     constraints_per_int_variables_.resize(<a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>.size());
<a name="l01384"></a>01384     constraints_per_bool_variables_.resize(<a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>.size());
<a name="l01385"></a>01385     int_args_.resize(<a class="code" href="classoperations__research_1_1ParserState.html#8452056d6e92360938cb4cad20b946d8">int_variables_</a>.size());
<a name="l01386"></a>01386     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; int_args_.size(); ++i) {
<a name="l01387"></a>01387       int_args_[i] = <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstIntVar.html" title="Integer variable node.">AstIntVar</a>(i);
<a name="l01388"></a>01388     }
<a name="l01389"></a>01389     bool_args_.resize(<a class="code" href="classoperations__research_1_1ParserState.html#c4e63a64dcc1b5ee617c82fcf1f4c733">bool_variables_</a>.size());
<a name="l01390"></a>01390     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; bool_args_.size(); ++i) {
<a name="l01391"></a>01391       bool_args_[i] = <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstBoolVar.html" title="Boolean variable node.">AstBoolVar</a>(i);
<a name="l01392"></a>01392     }
<a name="l01393"></a>01393   }
<a name="l01394"></a>01394 }
<a name="l01395"></a>01395 
<a name="l01396"></a><a class="code" href="classoperations__research_1_1ParserState.html#7db978057b6a60155129d500606afe33">01396</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1ParserState.html#7db978057b6a60155129d500606afe33">ParserState::FillOutput</a>(<a class="code" href="classoperations__research_1_1FlatZincModel.html" title="A space that can be initialized with a FlatZinc model.">operations_research::FlatZincModel</a>&amp; m) {
<a name="l01397"></a>01397   m.<a class="code" href="classoperations__research_1_1FlatZincModel.html#f79a721ce6e15b26df0aa4b926441fe3">InitOutput</a>(<a class="code" href="classoperations__research_1_1ParserState.html#6dda89067c3a8489d6af4d561fe4a054">Output</a>());
<a name="l01398"></a>01398 }
<a name="l01399"></a>01399 
<a name="l01400"></a><a class="code" href="classoperations__research_1_1FlatZincModel.html#66e4081b0d3ae4cb047a225eb04d4ff7">01400</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1FlatZincModel.html#66e4081b0d3ae4cb047a225eb04d4ff7" title="Parse FlatZinc file fileName into fzs and return it.">FlatZincModel::Parse</a>(<span class="keyword">const</span> std::string&amp; filename) {
<a name="l01401"></a>01401   filename_ = filename;
<a name="l01402"></a>01402   filename_.resize(filename_.size() - 4);
<a name="l01403"></a>01403   <span class="keywordtype">size_t</span> found = filename_.find_last_of(<span class="stringliteral">"/\\"</span>);
<a name="l01404"></a>01404   <span class="keywordflow">if</span> (found != string::npos) {
<a name="l01405"></a>01405     filename_ = filename_.substr(found + 1);
<a name="l01406"></a>01406   }
<a name="l01407"></a>01407 <span class="preprocessor">#ifdef HAVE_MMAP</span>
<a name="l01408"></a>01408 <span class="preprocessor"></span>  <span class="keywordtype">int</span> fd;
<a name="l01409"></a>01409   <span class="keywordtype">char</span>* data;
<a name="l01410"></a>01410   <span class="keyword">struct </span>stat sbuf;
<a name="l01411"></a>01411   fd = open(filename.c_str(), O_RDONLY);
<a name="l01412"></a>01412   <span class="keywordflow">if</span> (fd == -1) {
<a name="l01413"></a>01413     LOG(ERROR) &lt;&lt; <span class="stringliteral">"Cannot open file "</span> &lt;&lt; filename;
<a name="l01414"></a>01414     <span class="keywordflow">return</span> NULL;
<a name="l01415"></a>01415   }
<a name="l01416"></a>01416   <span class="keywordflow">if</span> (stat(filename.c_str(), &amp;sbuf) == -1) {
<a name="l01417"></a>01417     LOG(ERROR) &lt;&lt; <span class="stringliteral">"Cannot stat file "</span> &lt;&lt; filename;
<a name="l01418"></a>01418     <span class="keywordflow">return</span> NULL;
<a name="l01419"></a>01419   }
<a name="l01420"></a>01420   data = (<span class="keywordtype">char</span>*)mmap((caddr_t)0, sbuf.st_size, PROT_READ, MAP_SHARED, fd,0);
<a name="l01421"></a>01421   <span class="keywordflow">if</span> (data == (caddr_t)(-1)) {
<a name="l01422"></a>01422     LOG(ERROR) &lt;&lt; <span class="stringliteral">"Cannot mmap file "</span> &lt;&lt; filename;
<a name="l01423"></a>01423     <span class="keywordflow">return</span> NULL;
<a name="l01424"></a>01424   }
<a name="l01425"></a>01425 
<a name="l01426"></a>01426   <a class="code" href="classoperations__research_1_1ParserState.html" title="State of the FlatZinc parser">ParserState</a> pp(data, sbuf.st_size, <span class="keyword">this</span>);
<a name="l01427"></a>01427 <span class="preprocessor">#else</span>
<a name="l01428"></a>01428 <span class="preprocessor"></span>  std::ifstream file;
<a name="l01429"></a>01429   file.open(filename.c_str());
<a name="l01430"></a>01430   <span class="keywordflow">if</span> (!file.is_open()) {
<a name="l01431"></a>01431     LOG(FATAL) &lt;&lt; <span class="stringliteral">"Cannot open file "</span> &lt;&lt; filename;
<a name="l01432"></a>01432   }
<a name="l01433"></a>01433   std::string s = string(istreambuf_iterator&lt;char&gt;(file),
<a name="l01434"></a>01434                          istreambuf_iterator&lt;char&gt;());
<a name="l01435"></a>01435   <a class="code" href="classoperations__research_1_1ParserState.html" title="State of the FlatZinc parser">ParserState</a> pp(s, <span class="keyword">this</span>);
<a name="l01436"></a>01436 <span class="preprocessor">#endif</span>
<a name="l01437"></a>01437 <span class="preprocessor"></span>  <a class="code" href="lexer_8win_8cc.html#97c2c3079904c5fb2f235bb806ff20c7" title="User-visible API.">yylex_init</a>(&amp;pp.<a class="code" href="classoperations__research_1_1ParserState.html#934483fb2026744b2d9b34b2c9373dce">yyscanner</a>);
<a name="l01438"></a>01438   <a class="code" href="lexer_8win_8cc.html#90d20294722d171c4bf004fda3cd9403" title="Set the user-defined data.">yyset_extra</a>(&amp;pp, pp.<a class="code" href="classoperations__research_1_1ParserState.html#934483fb2026744b2d9b34b2c9373dce">yyscanner</a>);
<a name="l01439"></a>01439   <span class="comment">// yydebug = 1;</span>
<a name="l01440"></a>01440   <a class="code" href="parser_8cc.html#2df08e98c81c9d8bc1fd71defa327d4d">yyparse</a>(&amp;pp);
<a name="l01441"></a>01441   pp.<a class="code" href="classoperations__research_1_1ParserState.html#7db978057b6a60155129d500606afe33">FillOutput</a>(*<span class="keyword">this</span>);
<a name="l01442"></a>01442 
<a name="l01443"></a>01443   <span class="keywordflow">if</span> (pp.<a class="code" href="classoperations__research_1_1ParserState.html#934483fb2026744b2d9b34b2c9373dce">yyscanner</a>)
<a name="l01444"></a>01444     <a class="code" href="lexer_8win_8cc.html#aea60d8102c2afdd7d8e07bc43c530c3" title="Accessor methods to globals.">yylex_destroy</a>(pp.<a class="code" href="classoperations__research_1_1ParserState.html#934483fb2026744b2d9b34b2c9373dce">yyscanner</a>);
<a name="l01445"></a>01445   parsed_ok_ = !pp.<a class="code" href="classoperations__research_1_1ParserState.html#162dbbfaa104af4a338457f84fcaeb84">hadError</a>;
<a name="l01446"></a>01446 }
<a name="l01447"></a>01447 
<a name="l01448"></a><a class="code" href="classoperations__research_1_1FlatZincModel.html#33d497390b85454e8227ddfec5f07944">01448</a> <span class="keywordtype">void</span> <a class="code" href="classoperations__research_1_1FlatZincModel.html#66e4081b0d3ae4cb047a225eb04d4ff7" title="Parse FlatZinc file fileName into fzs and return it.">FlatZincModel::Parse</a>(std::istream&amp; is) {
<a name="l01449"></a>01449   filename_ = <span class="stringliteral">"stdin"</span>;
<a name="l01450"></a>01450   std::string s = string(istreambuf_iterator&lt;char&gt;(is),
<a name="l01451"></a>01451                          istreambuf_iterator&lt;char&gt;());
<a name="l01452"></a>01452 
<a name="l01453"></a>01453   <a class="code" href="classoperations__research_1_1ParserState.html" title="State of the FlatZinc parser">ParserState</a> pp(s, <span class="keyword">this</span>);
<a name="l01454"></a>01454   <a class="code" href="lexer_8win_8cc.html#97c2c3079904c5fb2f235bb806ff20c7" title="User-visible API.">yylex_init</a>(&amp;pp.<a class="code" href="classoperations__research_1_1ParserState.html#934483fb2026744b2d9b34b2c9373dce">yyscanner</a>);
<a name="l01455"></a>01455   <a class="code" href="lexer_8win_8cc.html#90d20294722d171c4bf004fda3cd9403" title="Set the user-defined data.">yyset_extra</a>(&amp;pp, pp.<a class="code" href="classoperations__research_1_1ParserState.html#934483fb2026744b2d9b34b2c9373dce">yyscanner</a>);
<a name="l01456"></a>01456   <span class="comment">// yydebug = 1;</span>
<a name="l01457"></a>01457   <a class="code" href="parser_8cc.html#2df08e98c81c9d8bc1fd71defa327d4d">yyparse</a>(&amp;pp);
<a name="l01458"></a>01458   pp.<a class="code" href="classoperations__research_1_1ParserState.html#7db978057b6a60155129d500606afe33">FillOutput</a>(*<span class="keyword">this</span>);
<a name="l01459"></a>01459 
<a name="l01460"></a>01460   <span class="keywordflow">if</span> (pp.<a class="code" href="classoperations__research_1_1ParserState.html#934483fb2026744b2d9b34b2c9373dce">yyscanner</a>)
<a name="l01461"></a>01461     <a class="code" href="lexer_8win_8cc.html#aea60d8102c2afdd7d8e07bc43c530c3" title="Accessor methods to globals.">yylex_destroy</a>(pp.<a class="code" href="classoperations__research_1_1ParserState.html#934483fb2026744b2d9b34b2c9373dce">yyscanner</a>);
<a name="l01462"></a>01462   parsed_ok_ = !pp.<a class="code" href="classoperations__research_1_1ParserState.html#162dbbfaa104af4a338457f84fcaeb84">hadError</a>;
<a name="l01463"></a>01463 }
<a name="l01464"></a>01464 
<a name="l01465"></a><a class="code" href="namespaceoperations__research.html#6bb31dcacb69917badcd5f1098c34597">01465</a> <a class="code" href="classoperations__research_1_1AstNode.html" title="A node in a FlatZinc abstract syntax tree.">AstNode</a>* <a class="code" href="namespaceoperations__research.html#6bb31dcacb69917badcd5f1098c34597">ArrayOutput</a>(<a class="code" href="classoperations__research_1_1AstCall.html" title="Node representing a function call">AstCall</a>* ann) {
<a name="l01466"></a>01466   <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>* a = NULL;
<a name="l01467"></a>01467 
<a name="l01468"></a>01468   <span class="keywordflow">if</span> (ann-&gt;<a class="code" href="classoperations__research_1_1AstCall.html#6c7424ca9ecbdc2908866948d163d979">args</a>-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#72542d2c0699a56955a3fad8fdd979b6" title="Test if node is an array node.">isArray</a>()) {
<a name="l01469"></a>01469     a = ann-&gt;<a class="code" href="classoperations__research_1_1AstCall.html#6c7424ca9ecbdc2908866948d163d979">args</a>-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#de326d9355b68c1d6b8e33a8521313fd" title="Cast this node to an array node.">getArray</a>();
<a name="l01470"></a>01470   } <span class="keywordflow">else</span> {
<a name="l01471"></a>01471     a = <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstArray.html" title="Array node">AstArray</a>(ann-&gt;<a class="code" href="classoperations__research_1_1AstCall.html#6c7424ca9ecbdc2908866948d163d979">args</a>);
<a name="l01472"></a>01472   }
<a name="l01473"></a>01473 
<a name="l01474"></a>01474   std::string out;
<a name="l01475"></a>01475 
<a name="l01476"></a>01476   out = StringPrintf(<span class="stringliteral">"array%dd("</span>, a-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>.size());;
<a name="l01477"></a>01477   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i = 0; i &lt; a-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>.size(); i++) {
<a name="l01478"></a>01478     <a class="code" href="classoperations__research_1_1AstSetLit.html" title="Set literal node">AstSetLit</a>* s = a-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[i]-&gt;getSet();
<a name="l01479"></a>01479     <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#217b1285625ccf45f463c495afeec9ec">empty</a>()) {
<a name="l01480"></a>01480       out += <span class="stringliteral">"{}, "</span>;
<a name="l01481"></a>01481     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#b1f3e7a964661a8cdc95e4da9f38d033">interval</a>) {
<a name="l01482"></a>01482       out += StringPrintf(<span class="stringliteral">"%d..%d, "</span>, s-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#cc6211973a92c4711637c205c1aaacae">imin</a>, s-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#7065f4f6a852778871d4a30cf478376a">imax</a>);
<a name="l01483"></a>01483     } <span class="keywordflow">else</span> {
<a name="l01484"></a>01484       out += <span class="stringliteral">"{"</span>;
<a name="l01485"></a>01485       <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> j = 0; j &lt; s-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#70658e37c7d9deb940af34cdd5f84add">s</a>.size(); j++) {
<a name="l01486"></a>01486         out += s-&gt;<a class="code" href="classoperations__research_1_1AstSetLit.html#70658e37c7d9deb940af34cdd5f84add">s</a>[j];
<a name="l01487"></a>01487         <span class="keywordflow">if</span> (j &lt; s-&gt;s.size() - 1) {
<a name="l01488"></a>01488           out += <span class="stringliteral">","</span>;
<a name="l01489"></a>01489         }
<a name="l01490"></a>01490       }
<a name="l01491"></a>01491       out += <span class="stringliteral">"}, "</span>;
<a name="l01492"></a>01492     }
<a name="l01493"></a>01493   }
<a name="l01494"></a>01494 
<a name="l01495"></a>01495   <span class="keywordflow">if</span> (!ann-&gt;<a class="code" href="classoperations__research_1_1AstCall.html#6c7424ca9ecbdc2908866948d163d979">args</a>-&gt;<a class="code" href="classoperations__research_1_1AstNode.html#72542d2c0699a56955a3fad8fdd979b6" title="Test if node is an array node.">isArray</a>()) {
<a name="l01496"></a>01496     a-&gt;<a class="code" href="classoperations__research_1_1AstArray.html#b0798e2b3779eb90c3fc7ed37379e815">a</a>[0] = NULL;
<a name="l01497"></a>01497     <span class="keyword">delete</span> a;
<a name="l01498"></a>01498   }
<a name="l01499"></a>01499   <span class="keywordflow">return</span> <span class="keyword">new</span> <a class="code" href="classoperations__research_1_1AstString.html" title="String node">AstString</a>(out);
<a name="l01500"></a>01500 }
<a name="l01501"></a>01501 }  <span class="comment">// namespace operations_research</span>
</pre></div></div>

  <!-- Start of footer. -->
  <table width=100% cellpadding=0 cellspacing=0 border=0>
    <tr valign=top>
      <td colspan=2 height=10></td>
    </tr>
    <tr valign=top>
      <td colspan=2 bgcolor=#359621 height=3></td>
    </tr>
  </table>

  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br /><br />
  <br /><br />

  
  </body>
</html>
